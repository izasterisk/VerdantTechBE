SCRIPT:
    /**
    * Deep sort object with optional array sorting
    * @param obj Object data
    * @param sortArrays Whether to sort arrays or maintain their order
    * @returns Sorted object data
    */
    function deepSortObj(obj, sortArrays = false) {
        return Object.keys(obj)
            .sort()
            .reduce((acc, key) => {
                const value = obj[key];

                if (Array.isArray(value)) {
                    if (sortArrays) {
                        // Sort array elements
                        acc[key] = value
                            .map((item) => (typeof item === 'object' && item !== null ? deepSortObj(item, sortArrays) : item))
                            .sort((a, b) => {
                                // Sort primitive values
                                if (typeof a !== 'object' && typeof b !== 'object') {
                                    return String(a).localeCompare(String(b));
                                }
                                // For objects, sort by JSON string representation
                                return JSON.stringify(a).localeCompare(JSON.stringify(b));
                            });
                    } else {
                        // Maintain array order, but sort objects within arrays
                        acc[key] = value.map((item) =>
                            typeof item === 'object' && item !== null ? deepSortObj(item, sortArrays) : item
                        );
                    }
                } else if (typeof value === 'object' && value !== null) {
                    acc[key] = deepSortObj(value, sortArrays);
                } else {
                    acc[key] = value;
                }

                return acc;
            }, {});
    }

    /**
    * Create HMAC signature using Web Crypto API (browser-compatible)
    *
    * @param {string} secretKey - Secret key for HMAC signature generation
    * @param {object} jsonData - JSON object data to be signed
    * @param {object} options - Configuration options
    * @param {boolean} options.encodeUri - Whether to URL encode keys and values (default: true)
    * @param {boolean} options.sortArrays - Whether to sort array elements (default: false)
    * @param {string} options.algorithm - HMAC algorithm: 'SHA-256', 'SHA-1', 'SHA-512' (default: 'SHA-256')
    * @returns {Promise<string>} HMAC signature in hexadecimal format
    *
    * @example
    * // Basic usage
    * const signature = await createSignatureBrowser('secret', { name: 'John', age: 30 });
    *
    * // In Postman Pre-request Script:
    * createSignatureBrowser(pm.environment.get("SECRET_KEY"), pm.request.body.raw).then(signature => {
    *   pm.request.headers.add({ key: "x-signature", value: signature });
    * });
    */
    async function createSignatureBrowser(secretKey, jsonData, options = {}) {
        const { encodeUri = true, sortArrays = false, algorithm = 'SHA-256' } = options;

        const sortedData = deepSortObj(jsonData, sortArrays);

        const queryString = Object.keys(sortedData)
            .map((key) => {
                let value = sortedData[key];

                // Handle arrays by JSON stringify them
                if (Array.isArray(value)) {
                    value = JSON.stringify(value);
                }
                // Handle nested objects
                if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                    value = JSON.stringify(value);
                }
                // Handle null/undefined values
                if (value === null || value === undefined) {
                    value = '';
                }

                // Conditionally URL encode the key and value based on options
                if (encodeUri) {
                    return `${encodeURIComponent(key)}=${encodeURIComponent(String(value))}`;
                }
                return `${key}=${value}`;
            })
            .join('&');

        // Web Crypto API implementation
        const encoder = new TextEncoder();
        const keyData = encoder.encode(secretKey);
        const messageData = encoder.encode(queryString);

        const cryptoKey = await crypto.subtle.importKey('raw', keyData, { name: 'HMAC', hash: algorithm }, false, ['sign']);

        const signature = await crypto.subtle.sign('HMAC', cryptoKey, messageData);
        const hashArray = Array.from(new Uint8Array(signature));
        const hashHex = hashArray.map((b) => b.toString(16).padStart(2, '0')).join('');

        return hashHex;
    }

    /**
    * Verify signature using Web Crypto API
    *
    * @param {string} secretKey - Secret key used for signature generation
    * @param {object} jsonData - JSON object data that was signed
    * @param {string} expectedSignature - Expected signature to verify against
    * @param {object} options - Configuration options (same as createSignatureBrowser)
    * @returns {Promise<boolean>} true if signatures match, false otherwise
    */
    async function verifySignatureBrowser(secretKey, jsonData, expectedSignature, options = {}) {
        const computedSignature = await createSignatureBrowser(secretKey, jsonData, options);
        return computedSignature.toLowerCase() === expectedSignature.toLowerCase();
    }

    // Example usage for Postman Pre-request Script:
    /*
    // Set your secret key in environment variables
    const secretKey = pm.environment.get("SECRET_KEY");

    // Get request body (assuming JSON)
    const requestBody = JSON.parse(pm.request.body.raw || "{}");

    // Create signature
    createSignatureBrowser(secretKey, requestBody, {
    encodeUri: true,
    sortArrays: false,
    algorithm: 'SHA-256'
    }).then(signature => {
    // Add signature to request headers
    pm.request.headers.add({
        key: "x-signature",
        value: signature
    });
    
    console.log("Generated signature:", signature);
    }).catch(error => {
    console.error("Error generating signature:", error);
    });
    */

    utils = {
        createSignatureBrowser,
        verifySignatureBrowser,
    };

PRE-REQUEST:
    const body = pm.request.body;

    const checkSum = pm.environment.get('payout-checksum-key');

    const referenceId = `payout_${Date.now()}`;
    pm.environment.set('payout-reference-id', referenceId);

    const preBody = {
        ...body,
        raw: {
            ...JSON.parse(body.raw),
            referenceId,
        }
    }

    await utils.createSignatureBrowser(checkSum, preBody.raw).then(signature => {
        pm.request.headers.upsert({
            key: 'x-signature',
            value: signature
        });
        pm.request.headers.upsert({
            key: 'x-idempotency-key',
            value: crypto.randomUUID()
        });
        pm.request.body.update(preBody);
    });

POST: https://api-merchant.payos.vn/v1/payouts
Headers: x-idempotency-key, x-client-id (PAYOS_CLIENT_ID_PAYOUT từ .env), x-api-key (PAYOS_API_KEY_PAYOUT từ .env), x-signature.
{
    "referenceId": "",
    "amount": 2000,
    "description": "payout",
    "toBin": "970422",
    "toAccountNumber": "0974164576",
    "category": [
        "vendorwalletcashout"
    ]
}

Response
{
    "code": "00",
    "desc": "success",
    "data": {
        "id": "batch_bc8707d2421545279056a5e4e54372ab",
        "referenceId": "payout_1752139775150",
        "transactions": [
            {
                "id": "batch_txn_bf89c7ca8a4e4ff7a0c4de69719e14a4",
                "referenceId": "payout_1752139775150",
                "amount": 200000,
                "description": "payout",
                "toBin": "970422",
                "toAccountNumber": "0969885457",
                "toAccountName": "NGUYEN VAN A",
                "reference": "262038",
                "transactionDatetime": "2025-07-10T16:29:42+07:00",
                "errorMessage": null,
                "errorCode": null,
                "state": "SUCCEEDED"
            }
        ],
        "category": [
            "salary",
            "hoa"
        ],
        "approvalState": "COMPLETED",
        "createdAt": "2025-07-10T16:29:37+07:00"
    }
}

{
  "code": "614",
  "desc": "Đã vượt quá hạn mức cho phép"
}

{
  "code": "624",
  "desc": "Số dư tài khoản không đủ để thực hiện giao dịch"
}

{
  "code": "607",
  "desc": "Tài khoản đích không hợp lệ"
}

{
  "code": "609",
  "desc": "Tạo lệnh chi thất bại"
}

{
  "code": "620",
  "desc": "Chuyển khoản thất bại"
}

{
  "code": "623",
  "desc": "Không tìm thấy tài khoản nhận"
}

{
  "code": "630",
  "desc": "Tài khoản không có quyền tạo lệnh chuyển khoản ngân hàng"
}