title Create Payment Link Sequence Diagram

participant Client
participant PayOSController
participant PayOSService
participant OrderRepository
participant PayOSApiClient
participant PaymentRepository
participant Database

Client->PayOSController: 1. POST /api/PayOS/create/{orderId} (CreatePaymentDataDTO)
activate PayOSController

PayOSController->PayOSController: 2. ValidateModel()
alt Validation Failed
    PayOSController->Client: 3. Return 400 Bad Request
    deactivate PayOSController
else Validation Success
    PayOSController->PayOSService: 4. CreatePaymentLinkAsync(orderId, dto, ct)
    activate PayOSService
    
    PayOSService->PayOSService: 5. Build cancelUrl and returnUrl from FRONTEND_URL env
    PayOSService->OrderRepository: 6. GetOrderWithRelationsByIdAsync(orderId)
    activate OrderRepository
    OrderRepository->Database: 7. Query order with order details and products
    activate Database
    Database-->OrderRepository: 8. Return order or null
    deactivate Database
    OrderRepository-->PayOSService: 9. Return order
    deactivate OrderRepository
    
    alt Order Invalid (not found / not Pending / is COD)
        PayOSService->PayOSService: 10a. Throw ArgumentException("Đơn hàng không khả dụng")
        PayOSService-->PayOSController: 11a. Exception propagated
        PayOSController->PayOSController: 12a. HandleException(ex)
        PayOSController->Client: 13a. Return 400 Bad Request
        deactivate PayOSService
        deactivate PayOSController
    else Order Valid
        PayOSService->PayOSService: 10b. Build items list from order.OrderDetails
        PayOSService->PayOSService: 11b. Generate unique orderCode (timestamp + random)
        PayOSService->PayOSApiClient: 12b. Loop: GetPaymentLinkInformationAsync(orderCode) until unique
        activate PayOSApiClient
        PayOSApiClient-->PayOSService: 13b. Throw exception if not exists (means unique)
        deactivate PayOSApiClient
        
        PayOSService->PayOSService: 14b. Build PaymentData object
        PayOSService->PayOSApiClient: 15b. CreatePaymentLinkAsync(paymentData)
        activate PayOSApiClient
        PayOSApiClient-->PayOSService: 16b. Return CreatePaymentResult (checkoutUrl, etc.)
        deactivate PayOSApiClient
        
        PayOSService->PayOSService: 17b. Create Payment entity with GatewayResponse
        PayOSService->PayOSService: 18b. Create Transaction entity (PaymentIn, Pending)
        PayOSService->PaymentRepository: 19b. CreatePaymentWithTransactionAsync(payment, transaction)
        activate PaymentRepository
        PaymentRepository->Database: 20b. Begin Transaction
        activate Database
        PaymentRepository->Database: 21b. INSERT payment
        Database-->PaymentRepository: 22b. Payment created
        PaymentRepository->Database: 23b. Get payment.Id
        PaymentRepository->Database: 24b. INSERT transaction with PaymentId
        Database-->PaymentRepository: 25b. Transaction created
        PaymentRepository->Database: 26b. Commit Transaction
        Database-->PaymentRepository: 27b. Transaction committed
        deactivate Database
        PaymentRepository-->PayOSService: 28b. Creation completed
        deactivate PaymentRepository
        
        PayOSService-->PayOSController: 29b. Return CreatePaymentResult
        deactivate PayOSService
        PayOSController->Client: 30b. Return 201 Created (CreatePaymentResult with checkoutUrl)
        deactivate PayOSController
    end
end

note over Client,Database: Creates payment link via PayOS API\nStores payment & transaction records\ncheckoutUrl is returned for user to pay
