title Create Forum Post Sequence Diagram

participant Client
participant ForumPostController
participant CloudinaryService
participant ForumPostService
participant NotificationService
participant ForumPostRepository
participant Database

Client->ForumPostController: 1. POST /api/ForumPost?userId={userId} (multipart/form-data: ForumPostCreateDTO)
activate ForumPostController

ForumPostController->ForumPostController: 2. ValidateModel()
alt Validation Failed
    ForumPostController->Client: 3a. Return 400 Bad Request
    deactivate ForumPostController
else Validation Success
    alt Has Images (dto.AddImages not null and not empty)
        ForumPostController->CloudinaryService: 3b1. UploadManyAsync(images, "forum_posts", cancellationToken)
        activate CloudinaryService
        CloudinaryService->CloudinaryService: 4b1. Upload each image to Cloudinary
        CloudinaryService-->ForumPostController: 5b1. Return upload results (PublicId, PublicUrl)
        deactivate CloudinaryService
        ForumPostController->ForumPostController: 6b1. Map to MediaLinkItemDTO list with Purpose="Front" for first image
    end
    
    ForumPostController->ForumPostService: 7b. CreateAsync(userId, dto, addImages, cancellationToken)
    activate ForumPostService
    
    ForumPostService->ForumPostService: 8b. Set now = DateTime.UtcNow
    ForumPostService->ForumPostService: 9b. Call GenerateUniqueSlug(dto.Title, cancellationToken)
    
    ForumPostService->ForumPostService: 10b. Map dto.Content list to ContentBlock entities
    ForumPostService->ForumPostService: 11b. Set each ContentBlock: Order=index, Type="text", Content=text
    
    ForumPostService->ForumPostService: 12b. Create ForumPost entity
    ForumPostService->ForumPostService: 13b. Set ForumPost properties (CategoryId, UserId, Title, Slug, Tags, Content)
    ForumPostService->ForumPostService: 14b. Set ViewCount=0, LikeCount=0, DislikeCount=0, IsPinned=false
    ForumPostService->ForumPostService: 15b. Set Status=Visible, CreatedAt=now, UpdatedAt=now
    
    alt Has AddImages
        ForumPostService->ForumPostService: 16b1. Map MediaLinkItemDTO to MediaLink entities
        ForumPostService->ForumPostService: 17b1. Set OwnerType=ForumPosts, Purpose=Front for first image
        ForumPostService->ForumPostService: 18b1. Set SortOrder=index, CreatedAt=now, UpdatedAt=now
    end
    
    ForumPostService->ForumPostRepository: 19b. CreateAsync(post, mediaEntities, cancellationToken)
    activate ForumPostRepository
    ForumPostRepository->Database: 20b. INSERT ForumPost
    activate Database
    Database-->ForumPostRepository: 21b. Return inserted post
    deactivate Database
    ForumPostRepository->Database: 22b. SaveChangesAsync()
    activate Database
    Database-->ForumPostRepository: 23b. Changes saved
    deactivate Database
    
    alt Has MediaEntities
        ForumPostRepository->ForumPostRepository: 24b1. Set each mediaLink.OwnerId = post.Id
        ForumPostRepository->Database: 25b1. INSERT MediaLinks (AddRangeAsync)
        activate Database
        Database-->ForumPostRepository: 26b1. MediaLinks inserted
        deactivate Database
        ForumPostRepository->Database: 27b1. SaveChangesAsync()
        activate Database
        Database-->ForumPostRepository: 28b1. Changes saved
        deactivate Database
    end
    
    ForumPostRepository-->ForumPostService: 29b. Task completed
    deactivate ForumPostRepository
    
    ForumPostService->NotificationService: 30b. CreateAndSendNotificationAsync(userId, title, message, type, post.Id, cancellationToken)
    activate NotificationService
    NotificationService-->ForumPostService: 31b. Notification created and sent
    deactivate NotificationService
    
    ForumPostService->ForumPostService: 32b. Map ForumPost to ForumPostResponseDTO
    alt mediaEntities not null
        ForumPostService->ForumPostService: 33b1. Map MediaLink entities to MediaLinkItemDTO list
        ForumPostService->ForumPostService: 34b1. Set result.Images with sorted media links
    end
    
    ForumPostService-->ForumPostController: 35b. Return ForumPostResponseDTO
    deactivate ForumPostService
    ForumPostController->Client: 36b. Return 200 OK (ForumPostResponseDTO)
    deactivate ForumPostController
end

note over Client,Database: Creates post with content blocks and images.\nFirst image is set as Front (thumbnail).\nNotification sent to users after post creation.

