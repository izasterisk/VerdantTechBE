title Create Forum Comment Sequence Diagram

participant Client
participant ForumCommentController
participant ForumCommentService
participant ForumCommentRepository
participant NotificationService
participant Database

Client->ForumCommentController: 1. POST /api/ForumComment (ForumCommentCreateDTO)
activate ForumCommentController

ForumCommentController->ForumCommentController: 2. ValidateModel()
alt Validation Failed
    ForumCommentController->Client: 3. Return 400 Bad Request
    deactivate ForumCommentController
else Validation Success
    ForumCommentController->ForumCommentService: 4. CreateAsync(dto, ct)
    activate ForumCommentService
    
    ForumCommentService->ForumCommentService: 5. Create ForumComment entity
    ForumCommentService->ForumCommentService: 6. Set ForumPostId, UserId, ParentId, Content
    ForumCommentService->ForumCommentService: 7. Set CreatedAt, UpdatedAt = DateTime.UtcNow
    ForumCommentService->ForumCommentService: 8. Set Status = Visible
    ForumCommentService->ForumCommentRepository: 9. CreateAsync(entity)
    activate ForumCommentRepository
    ForumCommentRepository->Database: 10. INSERT forum_comment
    activate Database
    Database-->ForumCommentRepository: 11. Comment created
    deactivate Database
    ForumCommentRepository->Database: 12. SaveChangesAsync()
    activate Database
    Database-->ForumCommentRepository: 13. Changes saved
    deactivate Database
    ForumCommentRepository-->ForumCommentService: 14. Creation completed
    deactivate ForumCommentRepository
    
    alt ParentId is null (Comment on Post)
        ForumCommentService->ForumCommentRepository: 15a. GetPostOwnerIdAsync(forumPostId)
        activate ForumCommentRepository
        ForumCommentRepository->Database: 16a. Query post owner ID
        activate Database
        Database-->ForumCommentRepository: 17a. Return postOwnerId
        deactivate Database
        ForumCommentRepository-->ForumCommentService: 18a. Return postOwnerId
        deactivate ForumCommentRepository
        
        alt Commenter is not Post Owner
            ForumCommentService->NotificationService: 19a1. CreateAndSendNotificationAsync()
            activate NotificationService
            NotificationService->Database: 20a1. INSERT notification
            activate Database
            Database-->NotificationService: 21a1. Notification created
            deactivate Database
            NotificationService-->ForumCommentService: 22a1. Notification sent
            deactivate NotificationService
        end
    else ParentId is not null (Reply to Comment)
        ForumCommentService->ForumCommentRepository: 15b. GetDetailAsync(parentId)
        activate ForumCommentRepository
        ForumCommentRepository->Database: 16b. Query parent comment
        activate Database
        Database-->ForumCommentRepository: 17b. Return parent comment
        deactivate Database
        ForumCommentRepository-->ForumCommentService: 18b. Return parent
        deactivate ForumCommentRepository
        
        alt Parent Exists and Commenter is not Parent Owner
            ForumCommentService->NotificationService: 19b1. CreateAndSendNotificationAsync()
            activate NotificationService
            NotificationService->Database: 20b1. INSERT notification
            activate Database
            Database-->NotificationService: 21b1. Notification created
            deactivate Database
            NotificationService-->ForumCommentService: 22b1. Notification sent
            deactivate NotificationService
        end
    end
    
    ForumCommentService->ForumCommentService: 15c. MapWithReplies(entity)
    ForumCommentService-->ForumCommentController: 16c. Return ForumCommentResponseDTO
    deactivate ForumCommentService
    
    ForumCommentController->Client: 17c. Return 200 OK (ForumCommentResponseDTO)
    deactivate ForumCommentController
end

note over Client,Database: Creates comment or reply\nSends notification to post owner or parent comment owner\nExcludes self-notifications

