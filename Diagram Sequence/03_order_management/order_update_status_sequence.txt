title Update Order Status Sequence Diagram

participant Staff
participant OrderUI
participant OrderController
participant OrderService
participant Database

Staff->OrderUI: 1. Update order status (orderId, dto)
OrderUI->OrderController: 2. PUT /api/Order/{orderId} (OrderUpdateDTO)
activate OrderController

note over OrderController: Requires Authorization (Admin/Staff)

OrderController->OrderController: 3. ValidateModel()
alt Validation Failed
    OrderController->OrderUI: 4.1 Return 400 Bad Request
    OrderUI->Staff: 5.1 Show error message
    deactivate OrderController
else Validation Success
    OrderController->OrderController: 4.2 GetCurrentUserId() (from JWT)
    OrderController->OrderService: 5.2 Call ProcessOrderAsync(staffId, orderId, dto)
    activate OrderService
    
    OrderService->Database: 6.2 Check if order exists
    Database-->OrderService: 7.2 Return order existence status
    
    alt Order Not Found
        OrderService-->OrderController: 8.1 Return failure message
        OrderController->OrderUI: 9.1 Return 404 Not Found
        OrderUI->Staff: 10.1 Show error message
        deactivate OrderService
        deactivate OrderController
    else Order Found
        opt Status = Cancelled
            OrderService->Database: 8.2.1 Update cancellation reason
            Database-->OrderService: 9.2.1 Return update result
        end
        OrderService->Database: 10.2 Update order status
        Database-->OrderService: 11.2 Return update result
        OrderService-->OrderController: 12.2 Return success message (OrderResponseDTO)
        deactivate OrderService
        OrderController->OrderUI: 13.2 Return 200 OK (OrderResponseDTO)
        deactivate OrderController
        OrderUI->Staff: 14.2 Display updated order
    end
end
