title Get Order By ID Sequence Diagram

participant Client
participant OrderController
participant OrderService
participant OrderRepository
participant AddressRepository
participant Database

Client->OrderController: 1. GET /api/Order/{orderId}
activate OrderController

note over OrderController: Requires Authorization

OrderController->OrderService: 2. Call GetOrderByIdAsync(orderId, cancellationToken)
activate OrderService

OrderService->OrderRepository: 3. GetOrderWithRelationsByIdAsync(orderId, cancellationToken)
activate OrderRepository

OrderRepository->Database: 4. Query Order by ID (Include OrderDetails, Product)
activate Database
Database-->OrderRepository: 5. Return order data or null
deactivate Database
OrderRepository-->OrderService: 6. Return order or null
deactivate OrderRepository

alt Order Not Found
    OrderService->OrderService: 7a. Throw KeyNotFoundException("Đơn hàng với ID {orderId} không tồn tại")
    OrderService-->OrderController: 8a. Exception propagated
    OrderController->OrderController: 9a. HandleException(ex)
    OrderController->Client: 10a. Return 500 Internal Server Error
    deactivate OrderService
    deactivate OrderController
else Order Found
    OrderService->OrderService: 7b. Map Order to OrderResponseDTO
    OrderService->OrderService: 8b. Loop through OrderDetails
    OrderService->OrderRepository: 9b. GetProductImagesByProductIdAsync(productId, cancellationToken)
    activate OrderRepository
    OrderRepository->Database: 10b. SELECT MediaLinks for product
    activate Database
    Database-->OrderRepository: 11b. Return product images
    deactivate Database
    OrderRepository-->OrderService: 12b. Return product images
    deactivate OrderRepository
    OrderService->OrderService: 13b. Map images to ProductImageResponseDTO
    OrderService->OrderService: 14b. Attach images to product in OrderDetails
    
    OrderService->OrderRepository: 15b. GetUserByIdAsync(customerId, cancellationToken)
    activate OrderRepository
    OrderRepository->Database: 16b. SELECT User by ID
    activate Database
    Database-->OrderRepository: 17b. Return user data
    deactivate Database
    OrderRepository-->OrderService: 18b. Return user
    deactivate OrderRepository
    OrderService->OrderService: 19b. Map User to UserResponseDTO (Customer)
    
    OrderService->AddressRepository: 20b. GetAddressByIdAsync(addressId, cancellationToken)
    activate AddressRepository
    AddressRepository->Database: 21b. SELECT Address by ID
    activate Database
    Database-->AddressRepository: 22b. Return address data
    deactivate Database
    AddressRepository-->OrderService: 23b. Return address
    deactivate AddressRepository
    OrderService->OrderService: 24b. Map Address to AddressResponseDTO
    OrderService->OrderService: 25b. Insert address to Customer.UserAddresses (position 0)
    
    OrderService-->OrderController: 26b. Return OrderResponseDTO
    deactivate OrderService
    OrderController->Client: 27b. Return 200 OK (OrderResponseDTO)
    deactivate OrderController
end

note over Client,Database: Returns complete order details with products, images\nCustomer info with delivery address included

