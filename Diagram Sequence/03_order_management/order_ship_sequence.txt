title Ship Order Sequence Diagram

participant Client
participant OrderController
participant OrderService
participant OrderDetailRepository
participant UserService
participant AddressRepository
participant GoshipCourierApiClient
participant OrderRepository
participant ExportInventoryRepository
participant Database

Client->OrderController: 1. POST /api/Order/{orderId}/ship (List<OrderDetailsExportDTO>)
activate OrderController

OrderController->OrderController: 2. ValidateModel()
alt Validation Failed
    OrderController->Client: 3. Return 400 Bad Request
    deactivate OrderController
else Validation Success
    OrderController->OrderController: 4. GetCurrentUserId() (from JWT)
    OrderController->OrderService: 5. ShipOrderAsync(staffId, orderId, dtos, ct)
    activate OrderService
    
    alt DTOs Empty or Null
        OrderService->OrderService: 6a. Throw ArgumentNullException("dtos rỗng")
        OrderService-->OrderController: 7a. Exception propagated
        OrderController->OrderController: 8a. HandleException(ex)
        OrderController->Client: 9a. Return 400 Bad Request
        deactivate OrderService
        deactivate OrderController
    else DTOs Valid
        OrderService->OrderRepository: 6b. GetOrderWithRelationsByIdAsync(orderId)
        activate OrderRepository
        OrderRepository->Database: 7b. Query order with order details
        activate Database
        Database-->OrderRepository: 8b. Return order or null
        deactivate Database
        OrderRepository-->OrderService: 9b. Return order
        deactivate OrderRepository
        
        alt Order Not Found
            OrderService->OrderService: 10b1. Throw KeyNotFoundException("Đơn hàng không tồn tại")
            OrderService-->OrderController: 11b1. Exception propagated
            OrderController->OrderController: 12b1. HandleException(ex)
            OrderController->Client: 13b1. Return 404 Not Found
            deactivate OrderService
            deactivate OrderController
        else Order Found
            OrderService->OrderService: 10b2. Validate serial/lot for each OrderDetailExportDTO
            OrderService->OrderDetailRepository: 11b2. IsSerialRequiredByProductIdAsync() for each
            activate OrderDetailRepository
            OrderDetailRepository->Database: 12b2. Check serial requirement
            activate Database
            Database-->OrderDetailRepository: 13b2. Return isRequired
            deactivate Database
            OrderDetailRepository-->OrderService: 14b2. Return isRequired
            deactivate OrderDetailRepository
            
            alt Validation Failed (serial/lot errors)
                OrderService->OrderService: 15b2a. Throw InvalidOperationException
                OrderService-->OrderController: 16b2a. Exception propagated
                OrderController->OrderController: 17b2a. HandleException(ex)
                OrderController->Client: 18b2a. Return 400 Bad Request
                deactivate OrderService
                deactivate OrderController
            else Validation Success
                OrderService->OrderDetailRepository: 15b2b. GetAllProductSerialToExportAsync(validateSerialNumber)
                activate OrderDetailRepository
                OrderDetailRepository->Database: 16b2b. Query product serials
                activate Database
                Database-->OrderDetailRepository: 17b2b. Return serials
                deactivate Database
                OrderDetailRepository-->OrderService: 18b2b. Return validatedSerials
                deactivate OrderDetailRepository
                
                OrderService->OrderService: 19b2b. Build ExportInventory list with ProductSerialId
                OrderService->UserService: 20b2b. GetUserByIdAsync(1) - get sender (system)
                activate UserService
                UserService-->OrderService: 21b2b. Return sender user
                deactivate UserService
                
                OrderService->OrderService: 22b2b. GetVerifiedAndActiveUserByIdAsync(order.CustomerId)
                OrderService->AddressRepository: 23b2b. GetAddressByIdAsync(order.AddressId)
                activate AddressRepository
                AddressRepository->Database: 24b2b. Query address
                activate Database
                Database-->AddressRepository: 25b2b. Return address or null
                deactivate Database
                AddressRepository-->OrderService: 26b2b. Return address
                deactivate AddressRepository
                
                alt Address Not Found
                    OrderService->OrderService: 27b2b1. Throw KeyNotFoundException("Địa chỉ không tồn tại")
                    OrderService-->OrderController: 28b2b1. Exception propagated
                    OrderController->OrderController: 29b2b1. HandleException(ex)
                    OrderController->Client: 30b2b1. Return 404 Not Found
                    deactivate OrderService
                    deactivate OrderController
                else Address Found
                    OrderService->OrderService: 27b2b2. Calculate payer and codAmount
                    OrderService->GoshipCourierApiClient: 28b2b2. CreateShipmentAsync(from, to, params)
                    activate GoshipCourierApiClient
                    GoshipCourierApiClient-->OrderService: 29b2b2. Return trackingNumber
                    deactivate GoshipCourierApiClient
                    
                    OrderService->OrderService: 30b2b2. Set order.TrackingNumber
                    OrderService->OrderService: 31b2b2. Set order.Status = Shipped
                    OrderService->OrderService: 32b2b2. Set order.ShippedAt = DateTime.UtcNow
                    OrderService->OrderRepository: 33b2b2. UpdateOrderWithTransactionAsync(order)
                    activate OrderRepository
                    OrderRepository->Database: 34b2b2. Begin Transaction
                    activate Database
                    OrderRepository->Database: 35b2b2. UPDATE order
                    Database-->OrderRepository: 36b2b2. Order updated
                    OrderRepository->Database: 37b2b2. Commit Transaction
                    Database-->OrderRepository: 38b2b2. Transaction committed
                    deactivate Database
                    OrderRepository-->OrderService: 39b2b2. Update completed
                    deactivate OrderRepository
                    
                    OrderService->ExportInventoryRepository: 40b2b2. CreateExportForOrderWithTransactionAsync(exports, serials)
                    activate ExportInventoryRepository
                    ExportInventoryRepository->Database: 41b2b2. Begin Transaction
                    activate Database
                    ExportInventoryRepository->Database: 42b2b2. INSERT export inventories
                    Database-->ExportInventoryRepository: 43b2b2. Exports created
                    ExportInventoryRepository->Database: 44b2b2. UPDATE product stock
                    Database-->ExportInventoryRepository: 45b2b2. Stock updated
                    ExportInventoryRepository->Database: 46b2b2. UPDATE serial status (if any)
                    Database-->ExportInventoryRepository: 47b2b2. Serials updated
                    ExportInventoryRepository->Database: 48b2b2. Commit Transaction
                    Database-->ExportInventoryRepository: 49b2b2. Transaction committed
                    deactivate Database
                    ExportInventoryRepository-->OrderService: 50b2b2. Export completed
                    deactivate ExportInventoryRepository
                    
                    OrderService->OrderRepository: 51b2b2. GetOrderWithRelationsByIdAsync(orderId)
                    activate OrderRepository
                    OrderRepository->Database: 52b2b2. Query updated order
                    activate Database
                    Database-->OrderRepository: 53b2b2. Return order
                    deactivate Database
                    OrderRepository-->OrderService: 54b2b2. Return order
                    deactivate OrderRepository
                    
                    OrderService->OrderService: 55b2b2. Map to OrderResponseDTO
                    OrderService-->OrderController: 56b2b2. Return OrderResponseDTO
                    deactivate OrderService
                    OrderController->Client: 57b2b2. Return 200 OK (OrderResponseDTO)
                    deactivate OrderController
                end
            end
        end
    end
end

note over Client,Database: Ship flow: validates serial/lot → creates shipment via Goship API\n→ updates order status → creates export inventories\nTwo transactions: order update & export creation

