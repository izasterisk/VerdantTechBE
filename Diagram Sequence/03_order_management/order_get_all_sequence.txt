title Get All Orders Sequence Diagram

participant Client
participant OrderController
participant OrderService
participant OrderRepository
participant Database

Client->OrderController: 1. GET /api/Order?page={page}&pageSize={pageSize}&status={status}
activate OrderController

note over OrderController: Requires Authorization (Admin/Staff)

OrderController->OrderService: 2. Call GetAllOrdersAsync(page, pageSize, status, cancellationToken)
activate OrderService

OrderService->OrderRepository: 3. GetAllOrdersAsync(page, pageSize, status, cancellationToken)
activate OrderRepository

OrderRepository->OrderRepository: 4. Build filter expression (status filter if provided)
alt Status Provided
    OrderRepository->OrderRepository: 5a. Parse status string to OrderStatus enum
    OrderRepository->OrderRepository: 6a. Create filter: o => o.Status == orderStatus
else No Status
    OrderRepository->OrderRepository: 5b. Create filter: o => true (all orders)
end

OrderRepository->Database: 7. GetPaginatedWithRelationsAsync()
activate Database
OrderRepository->Database: 8. Query orders (Include OrderDetails, Product, Address, Customer)
OrderRepository->Database: 9. OrderBy CreatedAt DESC
OrderRepository->Database: 10. Apply filter and pagination
Database-->OrderRepository: 11. Return orders list
OrderRepository->Database: 12. COUNT total records
Database-->OrderRepository: 13. Return total count
deactivate Database
OrderRepository-->OrderService: 14. Return (orders, totalCount)
deactivate OrderRepository

OrderService->OrderService: 15. Create empty response list
OrderService->OrderService: 16. Loop through orders
OrderService->OrderService: 17. Map Order to OrderResponseDTO
OrderService->OrderRepository: 18. GetProductImagesByProductIdAsync(productId, cancellationToken)
activate OrderRepository
OrderRepository->Database: 19. SELECT MediaLinks for product
activate Database
Database-->OrderRepository: 20. Return product images
deactivate Database
OrderRepository-->OrderService: 21. Return product images
deactivate OrderRepository
OrderService->OrderService: 22. Map images to ProductImageResponseDTO
OrderService->OrderService: 23. Attach images to product in OrderDetails
OrderService->OrderService: 24. Map Address to AddressResponseDTO
OrderService->OrderService: 25. Insert address to Customer.UserAddresses
OrderService->OrderService: 26. Add item to response list
OrderService->OrderService: 27. Calculate totalPages
OrderService->OrderService: 28. Create PagedResponse with pagination info
OrderService-->OrderController: 29. Return PagedResponse<OrderResponseDTO>
deactivate OrderService

OrderController->Client: 30. Return 200 OK (PagedResponse)
deactivate OrderController

note over Client,Database: Returns paginated orders with full details\nIncludes OrderDetails, Products with images, Customer, Address\nOptional filter by OrderStatus

