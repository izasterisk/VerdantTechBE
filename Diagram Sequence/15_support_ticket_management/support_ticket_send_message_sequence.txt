title Send New Support Request Message Sequence Diagram

participant User
participant SupportTicketDetailUI
participant RequestTicketController
participant RequestService
participant RequestRepository
participant UserRepository
participant Database

User->SupportTicketDetailUI: 1. Click "Gửi tin nhắn mới" button
User->SupportTicketDetailUI: 2. Enter message description and upload images (optional)
User->SupportTicketDetailUI: 3. Click "Gửi" button
SupportTicketDetailUI->RequestTicketController: 4. POST /api/RequestTicket/{requestId}/message (RequestMessageCreateDTO)
activate RequestTicketController

note over RequestTicketController: Requires Authorization

RequestTicketController->RequestTicketController: 5. ValidateModel()
alt Validation Failed
    RequestTicketController->SupportTicketDetailUI: 6.1 Return 400 Bad Request
    SupportTicketDetailUI->User: 7.1 Show validation error
    deactivate RequestTicketController
else Validation Success
    RequestTicketController->RequestTicketController: 6.2 GetCurrentUserId() (from JWT)
    RequestTicketController->RequestService: 7.2 Call SendNewRequestMessageAsync(userId, requestId, dto)
    activate RequestService
    
    RequestService->UserRepository: 8.2 ValidateUserVerifiedAndActiveAsync(userId)
    activate UserRepository
    UserRepository->Database: 9.2 Check if user is verified and active
    Database-->UserRepository: 10.2 Return validation result
    UserRepository-->RequestService: 11.2 Return validation result or throw exception
    deactivate UserRepository
    
    RequestService->RequestRepository: 12.2 GetRequestByIdWithMessagesAsync(requestId)
    activate RequestRepository
    RequestRepository->Database: 13.2 Get request with messages
    Database-->RequestRepository: 14.2 Return request data
    RequestRepository-->RequestService: 15.2 Return request with messages
    deactivate RequestRepository
    
    RequestService->RequestService: 16.2 Check if request belongs to user
    alt Request Not Belong to User
        RequestService-->RequestTicketController: 17.2.1 Throw UnauthorizedAccessException
        RequestTicketController->SupportTicketDetailUI: 18.2.1 Return 403 Forbidden
        SupportTicketDetailUI->User: 19.2.1 Show error message
        deactivate RequestService
        deactivate RequestTicketController
    else Request Belongs to User
        RequestService->RequestService: 17.2.2 Check message count (max 3 messages)
        alt Message Count >= 3
            RequestService-->RequestTicketController: 18.2.2.1 Throw InvalidOperationException
            RequestTicketController->SupportTicketDetailUI: 19.2.2.1 Return 400 Bad Request
            SupportTicketDetailUI->User: 20.2.2.1 Show error message
            deactivate RequestService
            deactivate RequestTicketController
        else Message Count < 3
            RequestService->RequestService: 18.2.2.2 Check if all previous messages have replies
            alt Previous Message Without Reply
                RequestService-->RequestTicketController: 19.2.2.2.1 Throw InvalidOperationException
                RequestTicketController->SupportTicketDetailUI: 20.2.2.2.1 Return 400 Bad Request
                SupportTicketDetailUI->User: 21.2.2.2.1 Show error message
                deactivate RequestService
                deactivate RequestTicketController
            else All Previous Messages Have Replies
                RequestService->RequestService: 19.2.2.2.2 Map DTO to RequestMessage entity
                RequestService->RequestService: 20.2.2.2.2 Map DTO images to MediaLink entities
                RequestService->RequestRepository: 21.2.2.2.2 CreateRequestMessageAsync(requestId, message, images)
                activate RequestRepository
                RequestRepository->Database: 22.2.2.2.2 Insert RequestMessage
                Database-->RequestRepository: 23.2.2.2.2 Return insert result
                opt Has Images
                    RequestRepository->Database: 24.2.2.2.2 Insert MediaLinks
                    Database-->RequestRepository: 25.2.2.2.2 Return insert result
                end
                RequestRepository-->RequestService: 26.2.2.2.2 Return created message
                deactivate RequestRepository
                
                RequestService->RequestRepository: 27.2.2.2.2 GetRequestByIdWithRelationsAsync(requestId)
                activate RequestRepository
                RequestRepository->Database: 28.2.2.2.2 Get request with relations
                Database-->RequestRepository: 29.2.2.2.2 Return request data
                RequestRepository-->RequestService: 30.2.2.2.2 Return request with relations
                deactivate RequestRepository
                
                RequestService->RequestService: 31.2.2.2.2 Map to RequestResponseDTO
                RequestService->RequestRepository: 32.2.2.2.2 GetAllImagesByRequestMessageIdAsync(messageId) for each message
                activate RequestRepository
                RequestRepository->Database: 33.2.2.2.2 Get images for each message
                Database-->RequestRepository: 34.2.2.2.2 Return images list
                RequestRepository-->RequestService: 35.2.2.2.2 Return images list
                deactivate RequestRepository
                
                RequestService-->RequestTicketController: 36.2.2.2.2 Return success (RequestResponseDTO)
                deactivate RequestService
                RequestTicketController->SupportTicketDetailUI: 37.2.2.2.2 Return 201 Created (RequestResponseDTO)
                deactivate RequestTicketController
                SupportTicketDetailUI->User: 38.2.2.2.2 Show success message and display updated request
            end
        end
    end
end

