title Process Support Request Sequence Diagram

participant Staff
participant SupportTicketManagementUI
participant RequestTicketController
participant RequestService
participant RequestRepository
participant NotificationService
participant Database

Staff->SupportTicketManagementUI: 1. Select support request and click "Xử lý"
Staff->SupportTicketManagementUI: 2. Fill form (Status and/or ReplyNotes)
Staff->SupportTicketManagementUI: 3. Click "Xác nhận xử lý" button
SupportTicketManagementUI->RequestTicketController: 4. PATCH /api/RequestTicket/{requestId}/process (RequestProcessDTO)
activate RequestTicketController

note over RequestTicketController: Requires Authorization (Admin/Staff)

RequestTicketController->RequestTicketController: 5. ValidateModel()
alt Validation Failed
    RequestTicketController->SupportTicketManagementUI: 6.1 Return 400 Bad Request
    SupportTicketManagementUI->Staff: 7.1 Show validation error
    deactivate RequestTicketController
else Validation Success
    RequestTicketController->RequestTicketController: 6.2 GetCurrentUserId() (from JWT)
    RequestTicketController->RequestService: 7.2 Call ProcessRequestAsync(staffId, requestId, dto)
    activate RequestService
    
    RequestService->RequestService: 8.2 Validate dto (must have Status or RequestMessages)
    alt Invalid DTO
        RequestService-->RequestTicketController: 9.2.1 Throw InvalidOperationException
        RequestTicketController->SupportTicketManagementUI: 10.2.1 Return 400 Bad Request
        SupportTicketManagementUI->Staff: 11.2.1 Show error message
        deactivate RequestService
        deactivate RequestTicketController
    else Valid DTO
        RequestService->RequestRepository: 9.2.2 GetRequestByIdAsync(requestId)
        activate RequestRepository
        RequestRepository->Database: 10.2.2 Get request by ID
        Database-->RequestRepository: 11.2.2 Return request data
        RequestRepository-->RequestService: 12.2.2 Return request
        deactivate RequestRepository
        
        RequestService->RequestService: 13.2.2 Validate request status (cannot be same, cannot be Pending/Completed)
        alt Status Invalid
            RequestService-->RequestTicketController: 14.2.2.1 Throw InvalidOperationException
            RequestTicketController->SupportTicketManagementUI: 15.2.2.1 Return 400 Bad Request
            SupportTicketManagementUI->Staff: 16.2.2.1 Show error message
            deactivate RequestService
            deactivate RequestTicketController
        else Status Valid
            RequestService->RequestService: 14.2.2.2 Validate InReview status (cannot have ReplyNotes)
            alt InReview with ReplyNotes
                RequestService-->RequestTicketController: 15.2.2.2.1 Throw InvalidOperationException
                RequestTicketController->SupportTicketManagementUI: 16.2.2.2.1 Return 400 Bad Request
                SupportTicketManagementUI->Staff: 17.2.2.2.1 Show error message
                deactivate RequestService
                deactivate RequestTicketController
            else Valid
                opt Has RequestMessages (ReplyNotes)
                    RequestService->RequestRepository: 15.2.2.2.2 GetRequestMessageByIdAsync(messageId)
                    activate RequestRepository
                    RequestRepository->Database: 16.2.2.2.2 Get request message by ID
                    Database-->RequestRepository: 17.2.2.2.2 Return message data
                    RequestRepository-->RequestService: 18.2.2.2.2 Return message
                    deactivate RequestRepository
                    RequestService->RequestService: 19.2.2.2.2 Update message (ReplyNotes, StaffId)
                end
                opt Has Status
                    RequestService->RequestService: 20.2.2.2.2 Update request status
                    opt Status is Rejected or Cancelled
                        RequestService->RequestService: 21.2.2.2.2 Set ProcessedBy and ProcessedAt
                    end
                end
                
                RequestService->RequestRepository: 22.2.2.2.2 UpdateRequestWithTransactionAsync(requestId, request, message)
                activate RequestRepository
                RequestRepository->Database: 23.2.2.2.2 Begin transaction
                opt Has RequestMessage
                    RequestRepository->Database: 24.2.2.2.2 Update RequestMessage
                    Database-->RequestRepository: 25.2.2.2.2 Return update result
                end
                opt Has Request
                    RequestRepository->Database: 26.2.2.2.2 Update Request
                    Database-->RequestRepository: 27.2.2.2.2 Return update result
                end
                RequestRepository->Database: 28.2.2.2.2 Commit transaction
                Database-->RequestRepository: 29.2.2.2.2 Return commit result
                RequestRepository-->RequestService: 30.2.2.2.2 Return updated requestId
                deactivate RequestRepository
                
                RequestService->RequestService: 31.2.2.2.2 Generate notification message based on status
                RequestService->NotificationService: 32.2.2.2.2 CreateAndSendNotificationAsync(userId, title, message, Request, requestId)
                activate NotificationService
                NotificationService->NotificationService: 33.2.2.2.2 Create and send notification
                NotificationService-->RequestService: 34.2.2.2.2 Return notification
                deactivate NotificationService
                
                RequestService->RequestRepository: 35.2.2.2.2 GetRequestByIdWithRelationsAsync(requestId)
                activate RequestRepository
                RequestRepository->Database: 36.2.2.2.2 Get request with relations
                Database-->RequestRepository: 37.2.2.2.2 Return request data
                RequestRepository-->RequestService: 38.2.2.2.2 Return request with relations
                deactivate RequestRepository
                
                RequestService->RequestService: 39.2.2.2.2 Map to RequestResponseDTO
                RequestService->RequestRepository: 40.2.2.2.2 GetAllImagesByRequestMessageIdAsync(messageId) for each message
                activate RequestRepository
                RequestRepository->Database: 41.2.2.2.2 Get images for each message
                Database-->RequestRepository: 42.2.2.2.2 Return images list
                RequestRepository-->RequestService: 43.2.2.2.2 Return images list
                deactivate RequestRepository
                
                RequestService-->RequestTicketController: 44.2.2.2.2 Return success (RequestResponseDTO)
                deactivate RequestService
                RequestTicketController->SupportTicketManagementUI: 45.2.2.2.2 Return 200 OK (RequestResponseDTO)
                deactivate RequestTicketController
                SupportTicketManagementUI->Staff: 46.2.2.2.2 Show success message and display updated request
            end
        end
    end
end

