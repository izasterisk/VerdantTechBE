title Create Batch Inventory Sequence Diagram

participant Staff
participant InventoryUI
participant BatchInventoryController
participant BatchInventoryService
participant BatchInventoryRepository
participant ProductRepository
participant UserRepository
participant Database

Staff->InventoryUI: 1. Create batch inventory (dto)
InventoryUI->BatchInventoryController: 2. POST /api/BatchInventory (BatchInventoryCreateDTO)
activate BatchInventoryController

BatchInventoryController->BatchInventoryService: 3. Call CreateAsync(dto)
activate BatchInventoryService

BatchInventoryService->ProductRepository: 4. GetProductByIdAsync(productId, useNoTracking: false)
activate ProductRepository
ProductRepository->Database: 5. Check if product exists
Database-->ProductRepository: 6. Return product data
ProductRepository-->BatchInventoryService: 7. Return product or null
deactivate ProductRepository

alt Product Not Found
    BatchInventoryService-->BatchInventoryController: 8.1 Throw KeyNotFoundException
    BatchInventoryController->InventoryUI: 9.1 Return 404 Not Found
    InventoryUI->Staff: 10.1 Show error message
    deactivate BatchInventoryService
    deactivate BatchInventoryController
else Product Found
    opt VendorId Provided
        BatchInventoryService->UserRepository: 8.2 GetVerifiedAndActiveUserByIdAsync(vendorId)
        activate UserRepository
        UserRepository->Database: 9.2 Check if vendor exists
        Database-->UserRepository: 10.2 Return user data
        UserRepository-->BatchInventoryService: 11.2 Return user or null
        deactivate UserRepository
        
        alt Vendor Not Found or Not Vendor Role
            BatchInventoryService-->BatchInventoryController: 12.2.1 Throw ArgumentException
            BatchInventoryController->InventoryUI: 13.2.1 Return 400 Bad Request
            InventoryUI->Staff: 14.2.1 Show error message
            deactivate BatchInventoryService
            deactivate BatchInventoryController
        else Valid Vendor
            BatchInventoryService->BatchInventoryService: 12.2.2 Validate serial requirements
            BatchInventoryService->BatchInventoryService: 12.2.3 Map DTO to BatchInventory entity
            BatchInventoryService->BatchInventoryRepository: 13.2.2 CreateAsync(entity)
            activate BatchInventoryRepository
            BatchInventoryRepository->Database: 14.2.2 Insert batch inventory
            Database-->BatchInventoryRepository: 15.2.2 Return insert result
            BatchInventoryRepository-->BatchInventoryService: 16.2.2 Return created batch inventory
            deactivate BatchInventoryRepository
            BatchInventoryService->ProductRepository: 17.2.2 UpdateProductStock(productId)
            activate ProductRepository
            ProductRepository->Database: 18.2.2 Calculate total quantity and update product stock
            Database-->ProductRepository: 19.2.2 Return update result
            ProductRepository-->BatchInventoryService: 20.2.2 Return update result
            deactivate ProductRepository
            BatchInventoryService-->BatchInventoryController: 21.2.2 Return success (BatchInventoryResponeDTO)
            deactivate BatchInventoryService
            BatchInventoryController->InventoryUI: 22.2.2 Return 200 OK (BatchInventoryResponeDTO)
            deactivate BatchInventoryController
            InventoryUI->Staff: 23.2.2 Display created batch inventory
        end
    else No VendorId
        BatchInventoryService->BatchInventoryService: 8.3 Validate serial requirements
        BatchInventoryService->BatchInventoryService: 8.4 Map DTO to BatchInventory entity
        BatchInventoryService->BatchInventoryRepository: 9.3 CreateAsync(entity)
        activate BatchInventoryRepository
        BatchInventoryRepository->Database: 10.3 Insert batch inventory
        Database-->BatchInventoryRepository: 11.3 Return insert result
        BatchInventoryRepository-->BatchInventoryService: 12.3 Return created batch inventory
        deactivate BatchInventoryRepository
        BatchInventoryService->ProductRepository: 13.3 UpdateProductStock(productId)
        activate ProductRepository
        ProductRepository->Database: 14.3 Calculate total quantity and update product stock
        Database-->ProductRepository: 15.3 Return update result
        ProductRepository-->BatchInventoryService: 16.3 Return update result
        deactivate ProductRepository
        BatchInventoryService-->BatchInventoryController: 17.3 Return success (BatchInventoryResponeDTO)
        deactivate BatchInventoryService
        BatchInventoryController->InventoryUI: 18.3 Return 200 OK (BatchInventoryResponeDTO)
        deactivate BatchInventoryController
        InventoryUI->Staff: 19.3 Display created batch inventory
    end
end

