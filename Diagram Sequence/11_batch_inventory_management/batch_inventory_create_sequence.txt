title Create Batch Inventory Sequence Diagram

participant Client
participant BatchInventoryController
participant BatchInventoryService
participant ProductRepository
participant UserRepository
participant BatchInventoryRepository
participant ProductSerialRepository
participant Database

Client->BatchInventoryController: 1. POST /api/BatchInventory (BatchInventoryCreateDTO)
activate BatchInventoryController

BatchInventoryController->BatchInventoryService: 2. Call CreateAsync(dto, ct)
activate BatchInventoryService

BatchInventoryService->ProductRepository: 3. GetProductByIdAsync(dto.ProductId, useNoTracking: true, ct)
activate ProductRepository
ProductRepository->Database: 4. Query Product by ID (Include Category)
activate Database
Database-->ProductRepository: 5. Return product data or null
deactivate Database
ProductRepository-->BatchInventoryService: 6. Return product or null
deactivate ProductRepository

alt Product Not Found
    BatchInventoryService->BatchInventoryService: 7a. Throw KeyNotFoundException("Không tìm thấy sản phẩm")
    BatchInventoryService-->BatchInventoryController: 8a. Exception propagated
    BatchInventoryController->BatchInventoryController: 9a. HandleException (catch KeyNotFoundException)
    BatchInventoryController->Client: 10a. Return 404 Not Found
    deactivate BatchInventoryService
    deactivate BatchInventoryController
else Product Found
    alt VendorId Provided
        BatchInventoryService->UserRepository: 7b1. GetVerifiedAndActiveUserByIdAsync(dto.VendorId, ct)
        activate UserRepository
        UserRepository->Database: 8b1. Query User (IsVerified=true, Status=Active)
        activate Database
        Database-->UserRepository: 9b1. Return user or exception
        deactivate Database
        UserRepository-->BatchInventoryService: 10b1. Return vendor user
        deactivate UserRepository
        
        alt Vendor Not Vendor Role
            BatchInventoryService->BatchInventoryService: 11b1a. Throw ArgumentException("Người dùng không phải là nhà cung cấp")
            BatchInventoryService-->BatchInventoryController: 12b1a. Exception propagated
            BatchInventoryController->BatchInventoryController: 13b1a. HandleException(ex)
            BatchInventoryController->Client: 14b1a. Return 400 Bad Request
            deactivate BatchInventoryService
            deactivate BatchInventoryController
        end
    end
    
    BatchInventoryService->BatchInventoryService: 7b2. Generate unique SKU
    BatchInventoryService->BatchInventoryRepository: 8b2. SkuExistsAsync(sku, null, ct)
    activate BatchInventoryRepository
    BatchInventoryRepository->Database: 9b2. Check SKU exists
    activate Database
    Database-->BatchInventoryRepository: 10b2. Return exists status
    deactivate Database
    BatchInventoryRepository-->BatchInventoryService: 11b2. Return exists status
    deactivate BatchInventoryRepository
    
    BatchInventoryService->BatchInventoryService: 12b2. Validate BatchNumber (format, length)
    BatchInventoryService->BatchInventoryRepository: 13b2. BatchNumberExistsAsync(batchNumber, null, ct)
    activate BatchInventoryRepository
    BatchInventoryRepository->Database: 14b2. Check BatchNumber exists (must be unique)
    activate Database
    Database-->BatchInventoryRepository: 15b2. Return exists status
    deactivate Database
    BatchInventoryRepository-->BatchInventoryService: 16b2. Return exists status
    deactivate BatchInventoryRepository
    
    alt BatchNumber Already Exists
        BatchInventoryService->BatchInventoryService: 17b2a. Throw ArgumentException("Số lô đã tồn tại")
        BatchInventoryService-->BatchInventoryController: 18b2a. Exception propagated
        BatchInventoryController->BatchInventoryController: 19b2a. HandleException(ex)
        BatchInventoryController->Client: 20b2a. Return 400 Bad Request
        deactivate BatchInventoryService
        deactivate BatchInventoryController
    end
    
    BatchInventoryService->BatchInventoryService: 17b2b. Validate LotNumber (format, length)
    BatchInventoryService->BatchInventoryService: 18b2b. Check if category.SerialRequired
    
    alt Serial Required
        alt No Serial Numbers Provided or Count Mismatch
            BatchInventoryService->BatchInventoryService: 19b2b1a. Throw ArgumentException
            BatchInventoryService-->BatchInventoryController: 20b2b1a. Exception propagated
            BatchInventoryController->BatchInventoryController: 21b2b1a. HandleException(ex)
            BatchInventoryController->Client: 22b2b1a. Return 400 Bad Request
            deactivate BatchInventoryService
            deactivate BatchInventoryController
        else Valid Serial Count
            BatchInventoryService->BatchInventoryService: 19b2b1b. Validate serials (remove empty, check duplicates)
            BatchInventoryService->ProductSerialRepository: 20b2b1b. GetExistingSerialNumbersAsync(validSerials, ct)
            activate ProductSerialRepository
            ProductSerialRepository->Database: 21b2b1b. Check if serials exist in DB
            activate Database
            Database-->ProductSerialRepository: 22b2b1b. Return existing serials
            deactivate Database
            ProductSerialRepository-->BatchInventoryService: 23b2b1b. Return existing serials
            deactivate ProductSerialRepository
            
            alt Serials Already Exist
                BatchInventoryService->BatchInventoryService: 24b2b1b1. Throw ArgumentException("Các serial đã tồn tại")
                BatchInventoryService-->BatchInventoryController: 25b2b1b1. Exception propagated
                BatchInventoryController->BatchInventoryController: 26b2b1b1. HandleException(ex)
                BatchInventoryController->Client: 27b2b1b1. Return 400 Bad Request
                deactivate BatchInventoryService
                deactivate BatchInventoryController
            end
        end
    else Serial Not Required
        alt Serial Numbers Provided
            BatchInventoryService->BatchInventoryService: 19b2b2a. Throw ArgumentException("Sản phẩm không yêu cầu serial")
            BatchInventoryService-->BatchInventoryController: 20b2b2a. Exception propagated
            BatchInventoryController->BatchInventoryController: 21b2b2a. HandleException(ex)
            BatchInventoryController->Client: 22b2b2a. Return 400 Bad Request
            deactivate BatchInventoryService
            deactivate BatchInventoryController
        end
    end
    
    BatchInventoryService->BatchInventoryService: 24b2b. Map DTO to BatchInventory entity
    BatchInventoryService->BatchInventoryService: 25b2b. Set entity.Sku = generated SKU
    BatchInventoryService->BatchInventoryRepository: 26b2b. CreateAsync(entity, ct)
    activate BatchInventoryRepository
    BatchInventoryRepository->Database: 27b2b. INSERT BatchInventory
    activate Database
    Database-->BatchInventoryRepository: 28b2b. Return created entity with ID
    deactivate Database
    BatchInventoryRepository-->BatchInventoryService: 29b2b. Return created BatchInventory
    deactivate BatchInventoryRepository
    
    alt Serial Required and Valid Serials
        BatchInventoryService->BatchInventoryService: 30b2b1. Create ProductSerial entities (Status=Stock)
        BatchInventoryService->ProductSerialRepository: 31b2b1. CreateRangeAsync(serials, ct)
        activate ProductSerialRepository
        ProductSerialRepository->Database: 32b2b1. INSERT ProductSerial records
        activate Database
        Database-->ProductSerialRepository: 33b2b1. Serials created
        deactivate Database
        ProductSerialRepository-->BatchInventoryService: 34b2b1. Complete
        deactivate ProductSerialRepository
    end
    
    BatchInventoryService->BatchInventoryService: 35b2b. Call UpdateProductStock(productId, ct)
    BatchInventoryService->BatchInventoryRepository: 36b2b. GetByProductIdAsync(productId, 1, MaxValue, ct)
    activate BatchInventoryRepository
    BatchInventoryRepository->Database: 37b2b. SELECT all batches for product
    activate Database
    Database-->BatchInventoryRepository: 38b2b. Return all batches
    deactivate Database
    BatchInventoryRepository-->BatchInventoryService: 39b2b. Return batches
    deactivate BatchInventoryRepository
    
    BatchInventoryService->BatchInventoryService: 40b2b. Calculate total quantity (Sum)
    BatchInventoryService->ProductRepository: 41b2b. UpdateStockAsync(productId, total, ct)
    activate ProductRepository
    ProductRepository->Database: 42b2b. UPDATE Product.Stock = total
    activate Database
    Database-->ProductRepository: 43b2b. Stock updated
    deactivate Database
    ProductRepository-->BatchInventoryService: 44b2b. Update complete
    deactivate ProductRepository
    
    BatchInventoryService->BatchInventoryService: 45b2b. Map BatchInventory to BatchInventoryResponeDTO
    BatchInventoryService-->BatchInventoryController: 46b2b. Return BatchInventoryResponeDTO
    deactivate BatchInventoryService
    BatchInventoryController->Client: 47b2b. Return 200 OK (BatchInventoryResponeDTO)
    deactivate BatchInventoryController
end

note over Client,Database: Creates batch inventory with validations\nAuto-generates unique SKU and validates BatchNumber\nCreates ProductSerial records if category requires serial\nUpdates product stock automatically

