title Update Batch Inventory Sequence Diagram

participant Staff
participant InventoryUI
participant BatchInventoryController
participant BatchInventoryService
participant BatchInventoryRepository
participant ProductRepository
participant UserRepository
participant Database

Staff->InventoryUI: 1. Update batch inventory (id, dto)
InventoryUI->BatchInventoryController: 2. PUT /api/BatchInventory/{id} (BatchInventoryUpdateDTO)
activate BatchInventoryController

BatchInventoryController->BatchInventoryService: 3. Call UpdateAsync(dto)
activate BatchInventoryService

BatchInventoryService->BatchInventoryRepository: 4. GetByIdAsync(id)
activate BatchInventoryRepository
BatchInventoryRepository->Database: 5. Check if batch inventory exists
Database-->BatchInventoryRepository: 6. Return batch inventory data
BatchInventoryRepository-->BatchInventoryService: 7. Return batchInventory or null
deactivate BatchInventoryRepository

alt Batch Inventory Not Found
    BatchInventoryService-->BatchInventoryController: 8.1 Throw KeyNotFoundException
    BatchInventoryController->InventoryUI: 9.1 Return 404 Not Found
    InventoryUI->Staff: 10.1 Show error message
    deactivate BatchInventoryService
    deactivate BatchInventoryController
else Batch Inventory Found
    BatchInventoryService->ProductRepository: 8.2 GetProductByIdAsync(productId, useNoTracking: true)
    activate ProductRepository
    ProductRepository->Database: 9.2 Check if product exists
    Database-->ProductRepository: 10.2 Return product data
    ProductRepository-->BatchInventoryService: 11.2 Return product or null
    deactivate ProductRepository
    
    alt Product Not Found
        BatchInventoryService-->BatchInventoryController: 12.2.1 Throw KeyNotFoundException
        BatchInventoryController->InventoryUI: 13.2.1 Return 404 Not Found
        InventoryUI->Staff: 14.2.1 Show error message
        deactivate BatchInventoryService
        deactivate BatchInventoryController
    else Product Found
        opt VendorId Provided
            BatchInventoryService->UserRepository: 12.2.2 GetUserWithAddressesByIdAsync(vendorId)
            activate UserRepository
            UserRepository->Database: 13.2.2 Check if vendor exists
            Database-->UserRepository: 14.2.2 Return user data
            UserRepository-->BatchInventoryService: 15.2.2 Return user or null
            deactivate UserRepository
            
            alt Vendor Not Found or Not Vendor Role
                BatchInventoryService-->BatchInventoryController: 16.2.2.1 Throw ArgumentException
                BatchInventoryController->InventoryUI: 17.2.2.1 Return 400 Bad Request
                InventoryUI->Staff: 18.2.2.1 Show error message
                deactivate BatchInventoryService
                deactivate BatchInventoryController
            else Valid Vendor
                BatchInventoryService->BatchInventoryService: 16.2.2.2 Validate serial requirements
                BatchInventoryService->BatchInventoryService: 16.2.2.3 Map DTO to existing entity
                BatchInventoryService->BatchInventoryRepository: 17.2.2.2 UpdateAsync(entity)
                activate BatchInventoryRepository
                BatchInventoryRepository->Database: 18.2.2.2 Update batch inventory
                Database-->BatchInventoryRepository: 19.2.2.2 Return update result
                BatchInventoryRepository-->BatchInventoryService: 20.2.2.2 Return updated batch inventory
                deactivate BatchInventoryRepository
                BatchInventoryService->ProductRepository: 21.2.2.2 UpdateProductStock(productId)
                activate ProductRepository
                ProductRepository->Database: 22.2.2.2 Calculate total quantity and update product stock
                Database-->ProductRepository: 23.2.2.2 Return update result
                ProductRepository-->BatchInventoryService: 24.2.2.2 Return update result
                deactivate ProductRepository
                BatchInventoryService-->BatchInventoryController: 25.2.2.2 Return success (BatchInventoryResponeDTO)
                deactivate BatchInventoryService
                BatchInventoryController->InventoryUI: 26.2.2.2 Return 200 OK (BatchInventoryResponeDTO)
                deactivate BatchInventoryController
                InventoryUI->Staff: 27.2.2.2 Display updated batch inventory
            end
        else No VendorId
            BatchInventoryService->BatchInventoryService: 12.2.3 Validate serial requirements
            BatchInventoryService->BatchInventoryService: 12.2.4 Map DTO to existing entity
            BatchInventoryService->BatchInventoryRepository: 13.2.3 UpdateAsync(entity)
            activate BatchInventoryRepository
            BatchInventoryRepository->Database: 14.2.3 Update batch inventory
            Database-->BatchInventoryRepository: 15.2.3 Return update result
            BatchInventoryRepository-->BatchInventoryService: 16.2.3 Return updated batch inventory
            deactivate BatchInventoryRepository
            BatchInventoryService->ProductRepository: 17.2.3 UpdateProductStock(productId)
            activate ProductRepository
            ProductRepository->Database: 18.2.3 Calculate total quantity and update product stock
            Database-->ProductRepository: 19.2.3 Return update result
            ProductRepository-->BatchInventoryService: 20.2.3 Return update result
            deactivate ProductRepository
            BatchInventoryService-->BatchInventoryController: 21.2.3 Return success (BatchInventoryResponeDTO)
            deactivate BatchInventoryService
            BatchInventoryController->InventoryUI: 22.2.3 Return 200 OK (BatchInventoryResponeDTO)
            deactivate BatchInventoryController
            InventoryUI->Staff: 23.2.3 Display updated batch inventory
        end
    end
end

