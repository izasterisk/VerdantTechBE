title Add Product to Cart Sequence Diagram

participant Client
participant CartController
participant CartService
participant CartRepository
participant Database

Client->CartController: 1. POST /api/Cart/add (CartDTO)
activate CartController

CartController->CartController: 2. ValidateModel()
alt Validation Failed
    CartController->Client: 3. Return 400 Bad Request
    deactivate CartController
else Validation Success
    CartController->CartController: 4. GetCurrentUserId() (from JWT)
    CartController->CartService: 5. AddToCartAsync(userId, dto, ct)
    activate CartService
    
    alt Quantity < 1
        CartService->CartService: 6a. Throw ArgumentOutOfRangeException("Số lượng phải > 0")
        CartService-->CartController: 7a. Exception propagated
        CartController->CartController: 8a. HandleException(ex)
        CartController->Client: 9a. Return 400 Bad Request
        deactivate CartService
        deactivate CartController
    else Quantity Valid
        CartService->CartRepository: 6b. GetCartByUserIdWithRelationsAsync(userId)
        activate CartRepository
        CartRepository->Database: 7b. Query cart by userId with items
        activate Database
        Database-->CartRepository: 8b. Return cart or null
        deactivate Database
        CartRepository-->CartService: 9b. Return cart or null
        deactivate CartRepository
        
        alt Cart Not Exists
            CartService->CartRepository: 10b1. CreateCartByUserIdWithTransactionAsync(userId)
            activate CartRepository
            CartRepository->Database: 11b1. Begin Transaction
            activate Database
            CartRepository->Database: 12b1. INSERT cart
            Database-->CartRepository: 13b1. Return created cart
            CartRepository->Database: 14b1. Commit Transaction
            Database-->CartRepository: 15b1. Transaction committed
            deactivate Database
            CartRepository-->CartService: 16b1. Return cart
            deactivate CartRepository
        else Cart Exists
            CartService->CartRepository: 10b2. CheckIfProductAlreadyInCart(cartId, productId)
            activate CartRepository
            CartRepository->Database: 11b2. Query cart_items (cartId, productId)
            activate Database
            Database-->CartRepository: 12b2. Return exists status
            deactivate Database
            CartRepository-->CartService: 13b2. Return exists (bool)
            deactivate CartRepository
            
            alt Product Already in Cart
                CartService->CartService: 14b2a. Throw InvalidOperationException("Sản phẩm đã tồn tại")
                CartService-->CartController: 15b2a. Exception propagated
                CartController->CartController: 16b2a. HandleException(ex)
                CartController->Client: 17b2a. Return 400 Bad Request
                deactivate CartService
                deactivate CartController
            end
        end
        
        CartService->CartService: 10b3. Map CartDTO to CartItem entity
        CartService->CartService: 11b3. Set cartItem.CartId
        CartService->CartRepository: 12b3. AddItemToCartWithTransactionAsync(cartItem)
        activate CartRepository
        CartRepository->Database: 13b3. Begin Transaction
        activate Database
        CartRepository->Database: 14b3. INSERT cart_item
        Database-->CartRepository: 15b3. Cart item added
        CartRepository->Database: 16b3. Commit Transaction
        Database-->CartRepository: 17b3. Transaction committed
        deactivate Database
        CartRepository-->CartService: 18b3. Item added
        deactivate CartRepository
        
        CartService->CartRepository: 19b3. GetCartByUserIdWithRelationsAsync(userId)
        activate CartRepository
        CartRepository->Database: 20b3. Query cart with items and product details
        activate Database
        Database-->CartRepository: 21b3. Return updated cart
        deactivate Database
        CartRepository-->CartService: 22b3. Return cart
        deactivate CartRepository
        
        CartService->CartService: 23b3. Map to CartResponseDTO
        CartService->CartService: 24b3. PopulateCartItemsImagesAsync() - load product images
        CartService->CartRepository: 25b3. Query product images for each cart item
        activate CartRepository
        CartRepository->Database: 26b3. Query media_links for products
        activate Database
        Database-->CartRepository: 27b3. Return images
        deactivate Database
        CartRepository-->CartService: 28b3. Return images
        deactivate CartRepository
        CartService->CartService: 29b3. Populate images to CartResponseDTO
        CartService-->CartController: 30b3. Return CartResponseDTO
        deactivate CartService
        CartController->Client: 31b3. Return 201 Created (CartResponseDTO)
        deactivate CartController
    end
end

note over Client,Database: Creates cart if not exists\nValidates product not already in cart\nPopulates product images in response
