title Create Export Inventories Sequence Diagram

participant Client
participant ExportInventoryController
participant ExportInventoryService
participant OrderDetailRepository
participant ExportInventoryRepository
participant Database

Client->ExportInventoryController: 1. POST /api/ExportInventory (List<ExportInventoryCreateDTO>)
activate ExportInventoryController

ExportInventoryController->ExportInventoryController: 2. ValidateModel()
alt Validation Failed
    ExportInventoryController->Client: 3. Return 400 Bad Request
    deactivate ExportInventoryController
else Validation Success
    ExportInventoryController->ExportInventoryController: 4. GetCurrentUserId() (from JWT)
    ExportInventoryController->ExportInventoryService: 5. CreateExportInventoriesAsync(staffId, dtos, ct)
    activate ExportInventoryService
    
    alt DTOs Empty or Null
        ExportInventoryService->ExportInventoryService: 6a. Throw ArgumentException("Danh sách không được rỗng")
        ExportInventoryService-->ExportInventoryController: 7a. Exception propagated
        ExportInventoryController->ExportInventoryController: 8a. HandleException(ex)
        ExportInventoryController->Client: 9a. Return 400 Bad Request
        deactivate ExportInventoryService
        deactivate ExportInventoryController
    else DTOs Valid
        ExportInventoryService->ExportInventoryService: 6b. Loop through DTOs
        ExportInventoryService->ExportInventoryService: 7b. Validate MovementType (not Sale)
        alt MovementType = Sale
            ExportInventoryService->ExportInventoryService: 8b1. Throw ArgumentException("Sale chỉ dùng khi xuất hàng bán")
            ExportInventoryService-->ExportInventoryController: 9b1. Exception propagated
            ExportInventoryController->ExportInventoryController: 10b1. HandleException(ex)
            ExportInventoryController->Client: 11b1. Return 400 Bad Request
            deactivate ExportInventoryService
            deactivate ExportInventoryController
        else MovementType Valid
            ExportInventoryService->OrderDetailRepository: 8b2. IsSerialRequiredByProductIdAsync(productId)
            activate OrderDetailRepository
            OrderDetailRepository->Database: 9b2. Check product serial requirement
            activate Database
            Database-->OrderDetailRepository: 10b2. Return isRequired (bool)
            deactivate Database
            OrderDetailRepository-->ExportInventoryService: 11b2. Return isRequired
            deactivate OrderDetailRepository
            
            alt Product Requires Serial
                alt Serial Not Provided or Quantity != 1
                    ExportInventoryService->ExportInventoryService: 12b2a. Throw InvalidOperationException
                    ExportInventoryService-->ExportInventoryController: 13b2a. Exception propagated
                    ExportInventoryController->ExportInventoryController: 14b2a. HandleException(ex)
                    ExportInventoryController->Client: 15b2a. Return 400 Bad Request
                    deactivate ExportInventoryService
                    deactivate ExportInventoryController
                else Serial Valid
                    ExportInventoryService->ExportInventoryService: 12b2b. Validate serial uniqueness
                    alt Serial Duplicate
                        ExportInventoryService->ExportInventoryService: 13b2b1. Throw ArgumentException("Số sê-ri trùng")
                        ExportInventoryService-->ExportInventoryController: 14b2b1. Exception propagated
                        ExportInventoryController->ExportInventoryController: 15b2b1. HandleException(ex)
                        ExportInventoryController->Client: 16b2b1. Return 400 Bad Request
                        deactivate ExportInventoryService
                        deactivate ExportInventoryController
                    else Serial Unique
                        ExportInventoryService->ExportInventoryService: 13b2b2. Add to validateSerialNumber dict
                    end
                end
            else Product No Serial Required
                alt Serial Provided
                    ExportInventoryService->ExportInventoryService: 12b2c. Throw InvalidOperationException("Không yêu cầu sê-ri")
                    ExportInventoryService-->ExportInventoryController: 13b2c. Exception propagated
                    ExportInventoryController->ExportInventoryController: 14b2c. HandleException(ex)
                    ExportInventoryController->Client: 15b2c. Return 400 Bad Request
                    deactivate ExportInventoryService
                    deactivate ExportInventoryController
                else No Serial
                    ExportInventoryService->ExportInventoryService: 12b2d. Validate lot number uniqueness
                    alt Lot Number Duplicate
                        ExportInventoryService->ExportInventoryService: 13b2d1. Throw InvalidOperationException("Số lô trùng")
                        ExportInventoryService-->ExportInventoryController: 14b2d1. Exception propagated
                        ExportInventoryController->ExportInventoryController: 15b2d1. HandleException(ex)
                        ExportInventoryController->Client: 16b2d1. Return 400 Bad Request
                        deactivate ExportInventoryService
                        deactivate ExportInventoryController
                    end
                end
            end
            
            ExportInventoryService->ExportInventoryService: 12b3. Build exportInventories list
            ExportInventoryService->ExportInventoryService: 13b3. Calculate productQuantities
            ExportInventoryService->OrderDetailRepository: 14b3. GetAllProductSerialToExportAsync(validateSerialNumber)
            activate OrderDetailRepository
            OrderDetailRepository->Database: 15b3. Query product serials
            activate Database
            Database-->OrderDetailRepository: 16b3. Return serials
            deactivate Database
            OrderDetailRepository-->ExportInventoryService: 17b3. Return validatedSerials
            deactivate OrderDetailRepository
            
            ExportInventoryService->ExportInventoryService: 18b3. Validate serial status
            alt Invalid Serial Status
                ExportInventoryService->ExportInventoryService: 19b3a. Throw InvalidOperationException
                ExportInventoryService-->ExportInventoryController: 20b3a. Exception propagated
                ExportInventoryController->ExportInventoryController: 21b3a. HandleException(ex)
                ExportInventoryController->Client: 22b3a. Return 400 Bad Request
                deactivate ExportInventoryService
                deactivate ExportInventoryController
            else All Serials Valid
                ExportInventoryService->ExportInventoryRepository: 19b3b. CreateExportForExportWithTransactionAsync()
                activate ExportInventoryRepository
                ExportInventoryRepository->Database: 20b3b. Begin Transaction
                activate Database
                ExportInventoryRepository->Database: 21b3b. INSERT export inventories
                Database-->ExportInventoryRepository: 22b3b. Return inserted records
                ExportInventoryRepository->Database: 23b3b. UPDATE product stock quantities
                Database-->ExportInventoryRepository: 24b3b. Stock updated
                ExportInventoryRepository->Database: 25b3b. UPDATE serial status to Adjustment (if any)
                Database-->ExportInventoryRepository: 26b3b. Serials updated
                ExportInventoryRepository->Database: 27b3b. Commit Transaction
                Database-->ExportInventoryRepository: 28b3b. Transaction committed
                deactivate Database
                ExportInventoryRepository-->ExportInventoryService: 29b3b. Return exportIds
                deactivate ExportInventoryRepository
                ExportInventoryService->ExportInventoryRepository: 30b3b. GetListedExportInventoriesByIdsAsync(exportIds)
                activate ExportInventoryRepository
                ExportInventoryRepository->Database: 31b3b. Query exports by IDs
                activate Database
                Database-->ExportInventoryRepository: 32b3b. Return export inventories
                deactivate Database
                ExportInventoryRepository-->ExportInventoryService: 33b3b. Return created exports
                deactivate ExportInventoryRepository
                ExportInventoryService->ExportInventoryService: 34b3b. Map to List<ExportInventoryResponseDTO>
                ExportInventoryService-->ExportInventoryController: 35b3b. Return List<ExportInventoryResponseDTO>
                deactivate ExportInventoryService
                ExportInventoryController->Client: 36b3b. Return 201 Created
                deactivate ExportInventoryController
            end
        end
    end
end

note over Client,Database: Complex validation: MovementType, serial requirements, lot number uniqueness\nTransaction updates: export records, product stock, serial status

