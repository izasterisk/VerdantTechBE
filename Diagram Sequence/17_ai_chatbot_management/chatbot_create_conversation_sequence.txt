title Create New Chatbot Conversation Sequence Diagram

participant User
participant ChatbotUI
participant ChatbotConversationController
participant ChatbotConversationService
participant UserRepository
participant ChatbotConversationRepository
participant Database

User->ChatbotUI: 1. Enter first message in chat
User->ChatbotUI: 2. Click "Gá»­i" button
ChatbotUI->ChatbotConversationController: 3. POST /api/ChatbotConversation (ChatbotMessageCreateDTO)
activate ChatbotConversationController

note over ChatbotConversationController: Requires Authorization

ChatbotConversationController->ChatbotConversationController: 4. ValidateModel()
alt Validation Failed
    ChatbotConversationController->ChatbotUI: 5.1 Return 400 Bad Request
    ChatbotUI->User: 6.1 Show validation error
    deactivate ChatbotConversationController
else Validation Success
    ChatbotConversationController->ChatbotConversationController: 5.2 GetCurrentUserId() (from JWT)
    ChatbotConversationController->ChatbotConversationService: 6.2 CreateNewChatbotConversationAsync(userId, dto)
    activate ChatbotConversationService
    
    ChatbotConversationService->UserRepository: 7.2 GetVerifiedAndActiveUserByIdAsync(userId)
    activate UserRepository
    UserRepository->Database: 8.2 Get user by ID and verify status
    Database-->UserRepository: 9.2 Return user data or throw exception
    UserRepository-->ChatbotConversationService: 10.2 Return user or throw exception
    deactivate UserRepository
    
    ChatbotConversationService->ChatbotConversationService: 11.2 Create ChatbotConversation entity
    ChatbotConversationService->ChatbotConversationService: 12.2 Map DTO to ChatbotMessage entity
    ChatbotConversationService->ChatbotConversationRepository: 13.2 CreateConversationWithTransactionAsync(conversation, message)
    activate ChatbotConversationRepository
    ChatbotConversationRepository->Database: 14.2 Begin transaction
    ChatbotConversationRepository->Database: 15.2 Insert ChatbotConversation
    Database-->ChatbotConversationRepository: 16.2 Return created conversation
    ChatbotConversationRepository->Database: 17.2 Insert ChatbotMessage
    Database-->ChatbotConversationRepository: 18.2 Return created message
    ChatbotConversationRepository->Database: 19.2 Commit transaction
    Database-->ChatbotConversationRepository: 20.2 Return commit result
    ChatbotConversationRepository-->ChatbotConversationService: 21.2 Return (conversation, message)
    deactivate ChatbotConversationRepository
    
    ChatbotConversationService->ChatbotConversationService: 22.2 Map to SendNewMessageResponseDTO
    ChatbotConversationService-->ChatbotConversationController: 23.2 Return SendNewMessageResponseDTO
    deactivate ChatbotConversationService
    
    ChatbotConversationController->ChatbotUI: 24.2 Return 201 Created (SendNewMessageResponseDTO)
    deactivate ChatbotConversationController
    ChatbotUI->User: 25.2 Display conversation and message
end

