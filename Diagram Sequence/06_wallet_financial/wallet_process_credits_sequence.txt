title Process Wallet Credits Sequence Diagram

participant Client
participant WalletController
participant WalletService
participant WalletRepository
participant Database

Client->WalletController: 1. POST /api/Wallet/process-credits
activate WalletController

WalletController->WalletController: 2. GetCurrentUserId() (from JWT)
WalletController->WalletService: 3. ProcessWalletCreditsAsync(userId, ct)
activate WalletService

WalletService->WalletRepository: 4. ValidateVendorQualified(userId)
activate WalletRepository
WalletRepository->Database: 5. Check if user is vendor (role + status)
activate Database
Database-->WalletRepository: 6. Return qualified status
deactivate Database
WalletRepository-->WalletService: 7. Return isQualified (bool)
deactivate WalletRepository

alt User Not Qualified
    WalletService->WalletService: 8a. Throw KeyNotFoundException("Không đủ điều kiện")
    WalletService-->WalletController: 9a. Exception propagated
    WalletController->WalletController: 10a. HandleException(ex)
    WalletController->Client: 11a. Return 404 Not Found
    deactivate WalletService
    deactivate WalletController
else User Qualified
    WalletService->WalletRepository: 8b. GetAllOrderDetailsAvailableForCreditAsync(userId)
    activate WalletRepository
    WalletRepository->Database: 9b. Query order details (IsWalletCredited=false, delivered)
    activate Database
    Database-->WalletRepository: 10b. Return order details list
    deactivate Database
    WalletRepository-->WalletService: 11b. Return orderDetails
    deactivate WalletRepository
    
    alt Has Order Details to Credit
        WalletService->WalletRepository: 12b1. GetWalletByUserIdAsync(userId)
        activate WalletRepository
        WalletRepository->Database: 13b1. Query wallet by userId
        activate Database
        Database-->WalletRepository: 14b1. Return wallet
        deactivate Database
        WalletRepository-->WalletService: 15b1. Return wallet
        deactivate WalletRepository
        
        WalletService->WalletService: 16b1. Loop through orderDetails
        WalletService->WalletService: 17b1. Set orderDetail.IsWalletCredited = true
        WalletService->WalletService: 18b1. Calculate credit: Subtotal * (100 - CommissionRate) / 100
        WalletService->WalletService: 19b1. Add to wallet.Balance
        
        WalletService->WalletRepository: 20b1. UpdateWalletAndOrderDetailsWithTransactionAsync(orderDetails, wallet)
        activate WalletRepository
        WalletRepository->Database: 21b1. Begin Transaction
        activate Database
        WalletRepository->Database: 22b1. UPDATE order_details SET IsWalletCredited = true
        Database-->WalletRepository: 23b1. Order details updated
        WalletRepository->Database: 24b1. UPDATE wallet SET Balance, UpdatedAt
        Database-->WalletRepository: 25b1. Wallet updated
        WalletRepository->Database: 26b1. Commit Transaction
        Database-->WalletRepository: 27b1. Transaction committed
        deactivate Database
        WalletRepository-->WalletService: 28b1. Update completed
        deactivate WalletRepository
    end
    
    WalletService->WalletRepository: 12b2. GetWalletByUserIdWithRelationsAsync(userId)
    activate WalletRepository
    WalletRepository->Database: 13b2. Query wallet with full relations
    activate Database
    Database-->WalletRepository: 14b2. Return wallet data
    deactivate Database
    WalletRepository-->WalletService: 15b2. Return wallet
    deactivate WalletRepository
    
    WalletService->WalletService: 16b2. Map to WalletResponseDTO
    WalletService-->WalletController: 17b2. Return WalletResponseDTO
    deactivate WalletService
    WalletController->Client: 18b2. Return 200 OK (WalletResponseDTO)
    deactivate WalletController
end

note over Client,Database: Credits vendor wallet from delivered orders\nCalculates: Subtotal * (100 - CommissionRate) / 100\nMarks order details as IsWalletCredited = true

