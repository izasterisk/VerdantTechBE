title Delete Wallet Cashout Request Sequence Diagram

participant Client
participant WalletController
participant WalletService
participant WalletRepository
participant Database

Client->WalletController: 1. DELETE /api/Wallet/cashout
activate WalletController

WalletController->WalletController: 2. GetCurrentUserId() (from JWT)
WalletController->WalletService: 3. DeleteWalletCashoutRequestAsync(userId, ct)
activate WalletService

WalletService->WalletRepository: 4. GetTransactionWithWalletCashoutRequestByUserIdAsync(userId)
activate WalletRepository
WalletRepository->Database: 5. Query transaction with cashout by userId
activate Database
Database-->WalletRepository: 6. Return transaction with cashout or null
deactivate Database
WalletRepository-->WalletService: 7. Return existingCashout (transaction) or null
deactivate WalletRepository

alt Cashout Not Found
    WalletService->WalletService: 8a. Throw KeyNotFoundException("Chưa có yêu cầu rút tiền")
    WalletService-->WalletController: 9a. Exception propagated
    WalletController->WalletController: 10a. HandleException(ex)
    WalletController->Client: 11a. Return 404 Not Found
    deactivate WalletService
    deactivate WalletController
else Cashout Found
    WalletService->WalletRepository: 8b. DeleteCashoutWithTransactionAsync(transaction, cashout)
    activate WalletRepository
    WalletRepository->Database: 9b. Begin Transaction
    activate Database
    WalletRepository->Database: 10b. DELETE cashout record
    Database-->WalletRepository: 11b. Cashout deleted
    WalletRepository->Database: 12b. DELETE transaction record
    Database-->WalletRepository: 13b. Transaction deleted
    WalletRepository->Database: 14b. Commit Transaction
    Database-->WalletRepository: 15b. Transaction committed
    deactivate Database
    WalletRepository-->WalletService: 16b. Return true
    deactivate WalletRepository
    
    WalletService-->WalletController: 17b. Return true
    deactivate WalletService
    WalletController->Client: 18b. Return 204 No Content
    deactivate WalletController
end

note over Client,Database: Only pending cashout requests can be deleted\nDeletes both cashout and transaction records in transaction

