title Get Wallet Cashout Request Sequence Diagram

participant WalletController
participant WalletService
participant WalletRepository
participant TransactionRepository
participant Database

note over WalletController: GET /api/Wallet/{userId}/cashout-request\nRequires Authorization (Admin, Staff, Vendor)

WalletController->WalletController: 1. GetCashoutRequest(userId)
activate WalletController

WalletController->WalletService: 2. GetWalletCashoutRequestAsync(userId, cancellationToken)
activate WalletService

WalletService->WalletRepository: 3. GetWalletCashoutRequestWithRelationsByUserIdAsync(userId, cancellationToken)
activate WalletRepository

WalletRepository->TransactionRepository: 4. GetWithRelationsAsync(predicate, true, includeFunc, cancellationToken)
activate TransactionRepository

note over TransactionRepository: predicate: UserId == userId\nTransactionType == WalletCashout\nStatus == Pending

TransactionRepository->Database: 5. SELECT Transaction with relations
activate Database
note over Database: Includes: BankAccount, CreatedByNavigation,\nUser, Cashout

Database-->TransactionRepository: 6. Return Transaction or null
deactivate Database

alt Transaction Not Found
    TransactionRepository-->WalletRepository: 7a. Return null
    deactivate TransactionRepository
    
    WalletRepository->WalletRepository: 8a. Throw KeyNotFoundException
    note over WalletRepository: Message: "Yêu cầu rút tiền của vendor ID {vendorId} không tồn tại."
    
    WalletRepository-->WalletService: 9a. Throw KeyNotFoundException
    deactivate WalletRepository
    
    WalletService-->WalletController: 10a. Throw KeyNotFoundException
    deactivate WalletService
    
    WalletController->WalletController: 11a. HandleException(ex)
    note over WalletController: Return 404 Not Found with error message
    
    WalletController-->WalletController: 12a. Return ActionResult<APIResponse>
    deactivate WalletController
else Transaction Found
    TransactionRepository-->WalletRepository: 7b. Return Transaction entity
    deactivate TransactionRepository
    
    WalletRepository-->WalletService: 8b. Return Transaction entity
    deactivate WalletRepository
    
    WalletService->WalletService: 9b. Map<TransactionResponseDTO>(createdCashout)
    note over WalletService: Map Transaction to TransactionResponseDTO
    
    WalletService-->WalletController: 10b. Return TransactionResponseDTO
    deactivate WalletService
    
    WalletController->WalletController: 11b. SuccessResponse(cashoutRequest)
    note over WalletController: Wrap in APIResponse with success status
    
    WalletController-->WalletController: 12b. Return 200 OK with TransactionResponseDTO
    deactivate WalletController
end

