title Update User Bank Account Sequence Diagram

participant Client
participant UserBankAccountsUI
participant UserBankAccountsController
participant UserBankAccountsService
participant VendorBankAccountsHelper
participant UserBankAccountsRepository
participant Database

Client->UserBankAccountsUI: 1. Request update bank account (accountId, UserBankAccountUpdateDTO)
UserBankAccountsUI->UserBankAccountsController: 2. PATCH /api/UserBankAccounts/{accountId} (UserBankAccountUpdateDTO)
activate UserBankAccountsController

UserBankAccountsController->UserBankAccountsController: 3. ValidateModel()
alt Validation Failed
    UserBankAccountsController->UserBankAccountsUI: 3.1 Return 400 Bad Request
    deactivate UserBankAccountsController
else Validation Success
    UserBankAccountsController->UserBankAccountsService: 3.2 Call UpdateUserBankAccountAsync(accountId, dto)
    activate UserBankAccountsService

    UserBankAccountsService->UserBankAccountsService: 4. Validate dto is not null
    alt BankCode is provided
        UserBankAccountsService->VendorBankAccountsHelper: 5. ValidateBankCode(dto.BankCode)
        activate VendorBankAccountsHelper
        VendorBankAccountsHelper->VendorBankAccountsHelper: 6. Check bank code validity
        VendorBankAccountsHelper-->UserBankAccountsService: 7. Return validation result
        deactivate VendorBankAccountsHelper

        alt Bank Code Invalid
            UserBankAccountsService-->UserBankAccountsController: 8.1 Throw exception
            UserBankAccountsController->UserBankAccountsUI: 9.1 Return 400 Bad Request
            deactivate UserBankAccountsService
            deactivate UserBankAccountsController
        end
    end

    UserBankAccountsService->UserBankAccountsRepository: 8.2 GetUserBankAccountByIdAsync(accountId)
    activate UserBankAccountsRepository
    UserBankAccountsRepository->Database: 9.2 Get bank account by ID
    Database-->UserBankAccountsRepository: 10.2 Return UserBankAccount or null
    UserBankAccountsRepository-->UserBankAccountsService: 11.2 Return UserBankAccount
    deactivate UserBankAccountsRepository

    alt Account Not Found
        UserBankAccountsService-->UserBankAccountsController: 12.1 Throw exception
        UserBankAccountsController->UserBankAccountsUI: 13.1 Return 404 Not Found
        deactivate UserBankAccountsService
        deactivate UserBankAccountsController
    else Account Found
        UserBankAccountsService->UserBankAccountsService: 12.2 Map DTO to Entity (AutoMapper - update fields)
        alt AccountNumber or AccountHolder changed
            UserBankAccountsService->UserBankAccountsRepository: 13.2 ValidateImportedBankAccount(userId, accountNumber, accountHolder)
            activate UserBankAccountsRepository
            UserBankAccountsRepository->Database: 14.2 Check for duplicate account
            Database-->UserBankAccountsRepository: 15.2 Return duplicate status
            UserBankAccountsRepository-->UserBankAccountsService: 16.2 Return bool (isDuplicate)
            deactivate UserBankAccountsRepository

            alt Duplicate Account Found
                UserBankAccountsService-->UserBankAccountsController: 17.1 Throw DuplicateNameException
                UserBankAccountsController->UserBankAccountsUI: 18.1 Return 400 Bad Request
                deactivate UserBankAccountsService
                deactivate UserBankAccountsController
            end
        end

        UserBankAccountsService->UserBankAccountsRepository: 17.2 UpdateUserBankAccountWithTransactionAsync(account)
        activate UserBankAccountsRepository
        UserBankAccountsRepository->Database: 18.2 Update bank account (transaction)
        Database-->UserBankAccountsRepository: 19.2 Return updated account
        UserBankAccountsRepository-->UserBankAccountsService: 20.2 Return UserBankAccount
        deactivate UserBankAccountsRepository

        UserBankAccountsService->UserBankAccountsService: 21.2 Map Entity to ResponseDTO (AutoMapper)
        UserBankAccountsService-->UserBankAccountsController: 22.2 Return UserBankAccountResponseDTO
        deactivate UserBankAccountsService

        UserBankAccountsController->UserBankAccountsUI: 23.2 Return 200 OK (APIResponse)
        deactivate UserBankAccountsController
        UserBankAccountsUI->Client: 24.2 Display success message
    end
end

