title Create User Bank Account Sequence Diagram

participant Client
participant UserBankAccountsUI
participant UserBankAccountsController
participant UserBankAccountsService
participant UserRepository
participant VendorBankAccountsHelper
participant UserBankAccountsRepository
participant Database

Client->UserBankAccountsUI: 1. Request create bank account (userId, UserBankAccountCreateDTO)
UserBankAccountsUI->UserBankAccountsController: 2. POST /api/UserBankAccounts/user/{userId} (UserBankAccountCreateDTO)
activate UserBankAccountsController

UserBankAccountsController->UserBankAccountsController: 3. ValidateModel()
alt Validation Failed
    UserBankAccountsController->UserBankAccountsUI: 3.1 Return 400 Bad Request
    deactivate UserBankAccountsController
else Validation Success
    UserBankAccountsController->UserBankAccountsService: 3.2 Call CreateUserBankAccountAsync(userId, dto)
    activate UserBankAccountsService

    UserBankAccountsService->UserBankAccountsService: 4. Validate dto is not null
    UserBankAccountsService->VendorBankAccountsHelper: 5. ValidateBankCode(dto.BankCode)
    activate VendorBankAccountsHelper
    VendorBankAccountsHelper->VendorBankAccountsHelper: 6. Check bank code validity
    VendorBankAccountsHelper-->UserBankAccountsService: 7. Return validation result
    deactivate VendorBankAccountsHelper

    alt Bank Code Invalid
        UserBankAccountsService-->UserBankAccountsController: 8.1 Throw exception
        UserBankAccountsController->UserBankAccountsUI: 9.1 Return 400 Bad Request
        deactivate UserBankAccountsService
        deactivate UserBankAccountsController
    else Bank Code Valid
        UserBankAccountsService->UserRepository: 8.2 GetUserByIdAsync(userId)
        activate UserRepository
        UserRepository->Database: 9.2 Check if user exists
        Database-->UserRepository: 10.2 Return user or null
        UserRepository-->UserBankAccountsService: 11.2 Return User
        deactivate UserRepository

        alt User Not Found
            UserBankAccountsService-->UserBankAccountsController: 12.1 Throw exception
            UserBankAccountsController->UserBankAccountsUI: 13.1 Return 404 Not Found
            deactivate UserBankAccountsService
            deactivate UserBankAccountsController
        else User Found
            UserBankAccountsService->UserBankAccountsService: 12.2 Map DTO to Entity (AutoMapper)
            UserBankAccountsService->UserBankAccountsService: 12.3 Set UserId on entity
            UserBankAccountsService->UserBankAccountsRepository: 13.2 CreateUserBankAccountWithTransactionAsync(account)
            activate UserBankAccountsRepository
            UserBankAccountsRepository->Database: 14.2 Insert new bank account (transaction)
            Database-->UserBankAccountsRepository: 15.2 Return created account
            UserBankAccountsRepository-->UserBankAccountsService: 16.2 Return UserBankAccount
            deactivate UserBankAccountsRepository

            UserBankAccountsService->UserBankAccountsService: 17.2 Map Entity to ResponseDTO (AutoMapper)
            UserBankAccountsService-->UserBankAccountsController: 18.2 Return UserBankAccountResponseDTO
            deactivate UserBankAccountsService

            UserBankAccountsController->UserBankAccountsUI: 19.2 Return 201 Created (APIResponse)
            deactivate UserBankAccountsController
            UserBankAccountsUI->Client: 20.2 Display success message
        end
    end
end

