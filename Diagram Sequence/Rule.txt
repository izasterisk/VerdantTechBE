========================================
QUY TẮC VIẾT SEQUENCE DIAGRAM
========================================

I. CÚ PHÁP CƠ BẢN
========================================

1. TIÊU ĐỀ (Title)
   title Tên Sequence Diagram

2. KHAI BÁO PARTICIPANTS (Các thành phần tham gia)
   participant TênThànhPhần
   
   Ví dụ:
   participant Client
   participant UserController
   participant UserService
   participant UserRepository
   participant Database

3. MESSAGES (Thông điệp giữa các thành phần)
   
   a) Message đồng bộ (synchronous):
      A->B: Mô tả message
   
   b) Message trả về (return):
      A-->B: Mô tả kết quả trả về
   
   c) Message tới chính nó (self-call):
      A->A: Xử lý nội bộ

4. LIFELINE (Kích hoạt/Hủy kích hoạt)
   
   activate TênThànhPhần    // Bắt đầu lifeline (thanh chữ nhật dọc)
   deactivate TênThànhPhần  // Kết thúc lifeline
   
   ⚠️ LƯU Ý QUAN TRỌNG:
   - PHẢI có activate khi một thành phần bắt đầu xử lý
   - PHẢI có deactivate tương ứng khi kết thúc
   - Bao gồm cả Database khi nó được truy vấn

5. ĐIỀU KIỆN (Alternative paths)
   
   alt Điều kiện 1
       // Các bước khi điều kiện 1 đúng
   else Điều kiện 2
       // Các bước khi điều kiện 2 đúng
   end

6. NOTE (Ghi chú)
   
   note over ThànhPhần1,ThànhPhần2: Nội dung ghi chú
   note over ThànhPhần: Ghi chú cho 1 thành phần

7. XUỐNG DÒNG TRONG MESSAGE
   
   Sử dụng \n để xuống dòng:
   A->B: Dòng 1\nDòng 2\nDòng 3

8. ĐỊNH DẠNG VĂN BẢN
   
   **text**: in đậm
   *text*: in nghiêng
   __text__: gạch dưới

9. NON-INSTANTANEOUS MESSAGE (Message không tức thời)
   
   A->(3)B: Message chậm
   // (3) là độ trễ, số càng lớn càng chậm

========================================
II. QUY TẮC BẮT BUỘC KHI VIẾT DIAGRAM
========================================

1. ĐÁNH SỐ THỨ TỰ
   ✅ BẮT BUỘC: Đánh số tuần tự từ 1, 2, 3...
   ✅ Với alt/else, dùng suffix a, b, c:
      - Nhánh 1: 9a, 10a, 11a...
      - Nhánh 2: 9b, 10b, 11b...
   ❌ TUYỆT ĐỐI KHÔNG: Nhảy số, đánh số lộn xộn

2. LIFELINE - QUAN TRỌNG NHẤT
   ✅ MỌI thành phần khi được gọi PHẢI có:
      - activate khi bắt đầu xử lý
      - deactivate khi kết thúc
   
   ✅ Bao gồm cả Database:
      UserRepository->Database: Query
      activate Database
      Database-->UserRepository: Result
      deactivate Database

3. FLOW ĐÚNG THEO CODE THỰC TẾ
   ✅ Phải match 100% với implementation
   ✅ Không được bỏ sót bước:
      - Validation
      - Mapping DTO ↔ Entity
      - Business logic
      - Database transaction (Begin/Commit)
      - Error handling
      - Return mapping

4. EXCEPTION HANDLING
   ✅ Khi có throw Exception:
      Service->Service: Throw Exception("message")
      Service-->Controller: Exception propagated
      Controller->Controller: HandleException(ex)
      Controller->Client: Return error response
      deactivate Service
      deactivate Controller

5. TRANSACTION (Nếu có)
   ✅ Phải thể hiện rõ:
      Repository->Database: Begin Transaction
      activate Database
      Repository->Database: Execute operations
      Repository->Database: Commit Transaction
      Database-->Repository: Transaction result
      deactivate Database

6. MAPPING
   ✅ Phải hiển thị các bước mapping:
      Service->Service: Map DTO to Entity
      Service->Service: Map Entity to ResponseDTO

7. MÔ TẢ MESSAGE CHÍNH XÁC
   ✅ Dùng tên method thực tế:
      CreateUserAsync(dto, cancellationToken)
   ✅ Return đúng kiểu dữ liệu:
      Return UserResponseDTO (không phải "success message")

========================================
III. TEMPLATE MẪU CHO CÁC CASE PHỔ BIẾN
========================================

A. TEMPLATE: API ENDPOINT CƠ BẢN
-----------------------------------
title [Tên chức năng] Sequence Diagram

participant Client
participant Controller
participant Service
participant Repository
participant Database

Client->Controller: 1. POST/GET/PUT/DELETE endpoint (DTO)
activate Controller

Controller->Controller: 2. ValidateModel()
alt Validation Failed
    Controller->Client: 3. Return 400 Bad Request
    deactivate Controller
else Validation Success
    Controller->Service: 4. Call ServiceMethod(dto)
    activate Service
    
    // Business logic here
    
    Service-->Controller: X. Return ResponseDTO
    deactivate Service
    Controller->Client: Y. Return 200/201 (ResponseDTO)
    deactivate Controller
end

B. TEMPLATE: CHECK TỒN TẠI + CREATE
-----------------------------------
Service->Repository: 5. CheckExistsAsync(key)
activate Repository
Repository->Database: 6. Check existence
activate Database
Database-->Repository: 7. Return exists status
deactivate Database
Repository-->Service: 8. Return exists (bool)
deactivate Repository

alt Already Exists
    Service->Service: 9a. Throw Exception("Already exists")
    Service-->Controller: 10a. Exception propagated
    Controller->Controller: 11a. HandleException(ex)
    Controller->Client: 12a. Return 400/409 Bad Request
    deactivate Service
    deactivate Controller
else Not Exists
    // Continue with create logic
end

C. TEMPLATE: CREATE VỚI TRANSACTION
-----------------------------------
Service->Service: 9b. Map DTO to Entity
Service->Repository: 10b. CreateWithTransactionAsync(entity)
activate Repository
Repository->Database: 11b. Begin Transaction
activate Database
Repository->Repository: 12b. Set default values
Repository->Database: 13b. Insert entity
Database-->Repository: 14b. Return insert result
Repository->Database: 15b. Commit Transaction
Database-->Repository: 16b. Transaction committed
deactivate Database
Repository-->Service: 17b. Return created entity
deactivate Repository

D. TEMPLATE: UPDATE
-----------------------------------
Service->Repository: X. GetByIdAsync(id)
activate Repository
Repository->Database: Y. SELECT by id
activate Database
Database-->Repository: Z. Return entity
deactivate Database
Repository-->Service: W. Return entity/null
deactivate Repository

alt Not Found
    Service->Service: Exception
else Found
    Service->Service: Map update data
    Service->Repository: UpdateAsync(entity)
    // Similar to create
end

E. TEMPLATE: DELETE (SOFT DELETE)
-----------------------------------
Service->Repository: X. GetByIdAsync(id)
// ... check exists ...

alt Found
    Service->Service: Set Status = Deleted
    Service->Service: Set DeletedAt = DateTime.UtcNow
    Service->Repository: UpdateAsync(entity)
    activate Repository
    Repository->Database: Begin Transaction
    activate Database
    Repository->Database: UPDATE entity
    Repository->Database: Commit Transaction
    deactivate Database
    Repository-->Service: Return result
    deactivate Repository
end

========================================
IV. CHECKLIST TRƯỚC KHI HOÀN THÀNH
========================================

□ 1. Có title rõ ràng
□ 2. Khai báo đầy đủ participants
□ 3. Đánh số tuần tự không bị nhảy
□ 4. MỌI thành phần có activate/deactivate
□ 5. Database có activate/deactivate khi được gọi
□ 6. Có validation ở đầu
□ 7. Có xử lý exception (alt nhánh lỗi)
□ 8. Có mapping DTO ↔ Entity
□ 9. Có transaction (nếu có trong code)
□ 10. Return đúng kiểu dữ liệu
□ 11. Message match với tên method thực tế
□ 12. Flow khớp 100% với code implementation
□ 13. Có note bổ sung (nếu cần)
□ 14. Các deactivate đúng thứ tự (LIFO - Last In First Out)

========================================
V. LỖI THƯỜNG GẶP PHẢI TRÁNH
========================================

❌ 1. Thiếu activate/deactivate cho Database
❌ 2. Đánh số nhảy: 3.1 → 4.2 → 6.1 → 8.2
❌ 3. Thiếu bước Map DTO to Entity
❌ 4. Thiếu bước Map Entity to ResponseDTO
❌ 5. Không hiển thị transaction Begin/Commit
❌ 6. Return "success message" thay vì ResponseDTO
❌ 7. Không có xử lý exception
❌ 8. Deactivate sai thứ tự
❌ 9. Thiếu ValidateModel() ở Controller
❌ 10. Không hiển thị Set default values trong Repository

========================================
VI. VÍ DỤ HOÀN CHỈNH
========================================

title User Registration Sequence Diagram

participant Client
participant UserController
participant UserService
participant UserRepository
participant Database

Client->UserController: 1. POST /api/User (UserCreateDTO)
activate UserController

UserController->UserController: 2. ValidateModel()
alt Validation Failed
    UserController->Client: 3. Return 400 Bad Request
    deactivate UserController
else Validation Success
    UserController->UserService: 4. Call CreateUserAsync(dto, cancellationToken)
    activate UserService
    
    UserService->UserRepository: 5. CheckEmailExistsAsync(email)
    activate UserRepository
    UserRepository->Database: 6. Check if email exists
    activate Database
    Database-->UserRepository: 7. Return email existence status
    deactivate Database
    UserRepository-->UserService: 8. Return emailExists (bool)
    deactivate UserRepository
    
    alt Email Already Exists
        UserService-->UserService: 9a. Throw Exception("Email already exists")
        UserService-->UserController: 10a. Exception propagated
        UserController->UserController: 11a. HandleException(ex)
        UserController->Client: 12a. Return 400 Bad Request
        deactivate UserService
        deactivate UserController
    else Email Available
        UserService->UserService: 9b. Map DTO to User entity
        UserService->UserService: 10b. Hash password
        UserService->UserService: 11b. Set IsVerified = false
        UserService->UserRepository: 12b. CreateUserWithTransactionAsync(user)
        activate UserRepository
        UserRepository->Database: 13b. Begin Transaction
        activate Database
        UserRepository->UserRepository: 14b. Set LastLoginAt, CreatedAt, UpdatedAt
        UserRepository->UserRepository: 15b. Set Status = Active
        UserRepository->UserRepository: 16b. Set Role = Customer (default)
        UserRepository->Database: 17b. Insert new user
        Database-->UserRepository: 18b. Return insert result
        UserRepository->Database: 19b. Commit Transaction
        Database-->UserRepository: 20b. Transaction committed
        deactivate Database
        UserRepository-->UserService: 21b. Return created User entity
        deactivate UserRepository
        UserService->UserService: 22b. Map User to UserResponseDTO
        UserService-->UserController: 23b. Return UserResponseDTO
        deactivate UserService
        UserController->Client: 24b. Return 201 Created (UserResponseDTO)
        deactivate UserController
    end
end

note over Client,Database: After registration, user should verify email\nby calling Send Verification endpoint

========================================
VII. GHI CHÚ BỔ SUNG
========================================

1. Tool hỗ trợ: sequencediagram.org hoặc tương tự
2. Luôn kiểm tra preview trước khi submit
3. Nếu diagram quá dài (>30 steps), cân nhắc chia nhỏ
4. Tham khảo code thực tế TRƯỚC KHI vẽ
5. Review lại checklist Section IV trước khi hoàn thành

========================================
CẬP NHẬT CUỐI: Dec 2025
========================================

