title Create Product Review Sequence Diagram

participant Client
participant ProductReviewController
participant CloudinaryService
participant ProductReviewService
participant OrderRepository
participant ProductReviewRepository
participant ProductRepository
participant Database

Client->ProductReviewController: 1. POST /api/ProductReview (CreateReviewForm)
activate ProductReviewController

note over ProductReviewController: Requires Authorization (Customer)

ProductReviewController->ProductReviewController: 2. ValidateModel()
alt Validation Failed
    ProductReviewController->Client: 3a. Return 400 Bad Request
    deactivate ProductReviewController
else Validation Success
    ProductReviewController->ProductReviewController: 3b. GetCurrentUserId()
    
    alt Has Images
        ProductReviewController->CloudinaryService: 4b1. UploadManyAsync(images, folder, cancellationToken)
        activate CloudinaryService
        CloudinaryService-->ProductReviewController: 5b1. Return upload results (PublicId, Url)
        deactivate CloudinaryService
        ProductReviewController->ProductReviewController: 6b1. Map to MediaLinkItemDTO list
    end
    
    ProductReviewController->ProductReviewService: 7b. CreateProductReviewAsync(customerId, dto, imagesDto, cancellationToken)
    activate ProductReviewService
    
    ProductReviewService->OrderRepository: 8b. GetOrderWithRelationsByIdAsync(orderId, cancellationToken)
    activate OrderRepository
    OrderRepository->Database: 9b. Query order by ID with OrderDetails and Product relations
    activate Database
    Database-->OrderRepository: 10b. Return order data or null
    deactivate Database
    OrderRepository-->ProductReviewService: 11b. Return order or null
    deactivate OrderRepository
    
    alt Order Not Found
        ProductReviewService->ProductReviewService: 12b1. Throw KeyNotFoundException("Đơn hàng không tồn tại")
        ProductReviewService-->ProductReviewController: 13b1. Exception propagated
        ProductReviewController->ProductReviewController: 14b1. HandleException(ex)
        ProductReviewController->Client: 15b1. Return 404 Not Found
        deactivate ProductReviewService
        deactivate ProductReviewController
    else Order Found
        ProductReviewService->ProductReviewService: 12b2. Validate order.CustomerId == customerId
        alt Customer ID Not Match
            ProductReviewService->ProductReviewService: 13b2a. Throw UnauthorizedAccessException
            ProductReviewService-->ProductReviewController: 14b2a. Exception propagated
            ProductReviewController->ProductReviewController: 15b2a. HandleException(ex)
            ProductReviewController->Client: 16b2a. Return 401 Unauthorized
            deactivate ProductReviewService
            deactivate ProductReviewController
        else Customer ID Match
            ProductReviewService->ProductReviewService: 13b2b. Validate order.Status (Paid/Shipped/Delivered)
            alt Order Status Invalid
                ProductReviewService->ProductReviewService: 14b2b1. Throw InvalidOperationException
                ProductReviewService-->ProductReviewController: 15b2b1. Exception propagated
                ProductReviewController->ProductReviewController: 16b2b1. HandleException(ex)
                ProductReviewController->Client: 17b2b1. Return 400 Bad Request
                deactivate ProductReviewService
                deactivate ProductReviewController
            else Order Status Valid
                ProductReviewService->ProductReviewService: 14b2b2. Find orderDetail where ProductId == dto.ProductId
                alt Product Not In Order
                    ProductReviewService->ProductReviewService: 15b2b2a. Throw InvalidOperationException
                    ProductReviewService-->ProductReviewController: 16b2b2a. Exception propagated
                    ProductReviewController->ProductReviewController: 17b2b2a. HandleException(ex)
                    ProductReviewController->Client: 18b2b2a. Return 400 Bad Request
                    deactivate ProductReviewService
                    deactivate ProductReviewController
                else Product In Order
                    ProductReviewService->ProductReviewRepository: 15b2b2b. GetProductReviewByProductOrderCustomerAsync(productId, orderId, customerId, useNoTracking: true, cancellationToken)
                    activate ProductReviewRepository
                    ProductReviewRepository->Database: 16b2b2b. Query review by ProductId, OrderId, CustomerId
                    activate Database
                    Database-->ProductReviewRepository: 17b2b2b. Return review or null
                    deactivate Database
                    ProductReviewRepository-->ProductReviewService: 18b2b2b. Return review or null
                    deactivate ProductReviewRepository
                    
                    alt Review Already Exists
                        ProductReviewService->ProductReviewService: 19b2b2b1. Throw InvalidOperationException("Đã đánh giá rồi")
                        ProductReviewService-->ProductReviewController: 20b2b2b1. Exception propagated
                        ProductReviewController->ProductReviewController: 21b2b2b1. HandleException(ex)
                        ProductReviewController->Client: 22b2b2b1. Return 400 Bad Request
                        deactivate ProductReviewService
                        deactivate ProductReviewController
                    else Review Not Exists Yet
                        ProductReviewService->ProductReviewService: 19b2b2b2. Map ProductReviewCreateDTO to ProductReview entity
                        ProductReviewService->ProductReviewService: 20b2b2b2. Set review.CustomerId = customerId
                        ProductReviewService->ProductReviewService: 21b2b2b2. Set review.CreatedAt, UpdatedAt = DateTime.UtcNow
                        
                        alt Has Images
                            ProductReviewService->ProductReviewService: 22b2b2b2a. Map MediaLinkItemDTO to MediaLink entities
                            ProductReviewService->ProductReviewService: 23b2b2b2a. Set OwnerType = ProductReviews, Purpose = None
                            ProductReviewService->ProductReviewService: 24b2b2b2a. Set CreatedAt, UpdatedAt = DateTime.UtcNow
                        end
                        
                        ProductReviewService->ProductReviewRepository: 25b2b2b2. CreateProductReviewWithTransactionAsync(review, mediaLinks, cancellationToken)
                        activate ProductReviewRepository
                        ProductReviewRepository->Database: 26b2b2b2. Begin Transaction
                        activate Database
                        ProductReviewRepository->ProductReviewRepository: 27b2b2b2. Set review.CreatedAt, UpdatedAt = DateTime.UtcNow
                        ProductReviewRepository->Database: 28b2b2b2. INSERT ProductReview
                        Database-->ProductReviewRepository: 29b2b2b2. Return inserted review
                        
                        alt Has MediaLinks
                            ProductReviewRepository->ProductReviewRepository: 30b2b2b2a. Iterate through mediaLinks
                            ProductReviewRepository->ProductReviewRepository: 31b2b2b2a. Set each mediaLink.OwnerId = createdReview.Id
                            ProductReviewRepository->ProductReviewRepository: 32b2b2b2a. Set OwnerType, Purpose, SortOrder, timestamps
                            ProductReviewRepository->Database: 33b2b2b2a. INSERT each MediaLink
                            activate Database
                            Database-->ProductReviewRepository: 34b2b2b2a. MediaLinks inserted
                            deactivate Database
                        end
                        
                        ProductReviewRepository->Database: 35b2b2b2. Commit Transaction
                        Database-->ProductReviewRepository: 36b2b2b2. Transaction committed
                        deactivate Database
                        ProductReviewRepository->ProductReviewRepository: 37b2b2b2. Call GetProductReviewByIdAsync(createdReview.Id, useNoTracking: false, cancellationToken)
                        ProductReviewRepository->Database: 38b2b2b2. Query review by ID with relations
                        activate Database
                        Database-->ProductReviewRepository: 39b2b2b2. Return review with relations
                        deactivate Database
                        ProductReviewRepository-->ProductReviewService: 40b2b2b2. Return created review
                        deactivate ProductReviewRepository
                        
                        ProductReviewService->ProductReviewService: 41b2b2b2. Call UpdateProductRatingAverageAsync(productId, cancellationToken)
                        ProductReviewService->ProductReviewRepository: 42b2b2b2. CalculateProductRatingAverageAsync(productId, cancellationToken)
                        activate ProductReviewRepository
                        ProductReviewRepository->Database: 43b2b2b2. Query all ratings for productId
                        activate Database
                        Database-->ProductReviewRepository: 44b2b2b2. Return list of ratings
                        deactivate Database
                        ProductReviewRepository->ProductReviewRepository: 45b2b2b2. Calculate average and round to 2 decimals
                        ProductReviewRepository-->ProductReviewService: 46b2b2b2. Return average (decimal)
                        deactivate ProductReviewRepository
                        
                        ProductReviewService->ProductRepository: 47b2b2b2. GetProductByIdAsync(productId, useNoTracking: false, cancellationToken)
                        activate ProductRepository
                        ProductRepository->Database: 48b2b2b2. Query product by ID
                        activate Database
                        Database-->ProductRepository: 49b2b2b2. Return product or null
                        deactivate Database
                        ProductRepository-->ProductReviewService: 50b2b2b2. Return product
                        deactivate ProductRepository
                        
                        alt Product Found
                            ProductReviewService->ProductReviewService: 51b2b2b2a. Set product.RatingAverage = average
                            ProductReviewService->ProductReviewService: 52b2b2b2a. Set product.UpdatedAt = DateTime.UtcNow
                            ProductReviewService->ProductRepository: 53b2b2b2a. UpdateProductAsync(product, cancellationToken)
                            activate ProductRepository
                            ProductRepository->Database: 54b2b2b2a. Query existing product by ID
                            activate Database
                            Database-->ProductRepository: 55b2b2b2a. Return existing product
                            deactivate Database
                            ProductRepository->ProductRepository: 56b2b2b2a. Update RatingAverage field
                            ProductRepository->ProductRepository: 57b2b2b2a. Set UpdatedAt = DateTime.UtcNow
                            ProductRepository->Database: 58b2b2b2a. UPDATE product
                            activate Database
                            Database-->ProductRepository: 59b2b2b2a. Update completed
                            deactivate Database
                            ProductRepository->Database: 60b2b2b2a. SaveChangesAsync()
                            activate Database
                            Database-->ProductRepository: 61b2b2b2a. Changes saved
                            deactivate Database
                            ProductRepository-->ProductReviewService: 62b2b2b2a. Return updated product
                            deactivate ProductRepository
                        end
                        
                        ProductReviewService->ProductReviewService: 63b2b2b2. Map createdReview to ProductReviewResponseDTO
                        alt createdReview.Customer != null
                            ProductReviewService->ProductReviewService: 64b2b2b2a. Map Customer to UserResponseDTO
                        end
                        
                        ProductReviewService->ProductReviewRepository: 65b2b2b2. GetAllImagesByReviewIdAsync(createdReview.Id, cancellationToken)
                        activate ProductReviewRepository
                        ProductReviewRepository->Database: 66b2b2b2. Query MediaLinks where OwnerType=ProductReviews AND OwnerId=reviewId
                        activate Database
                        Database-->ProductReviewRepository: 67b2b2b2. Return list of MediaLink
                        deactivate Database
                        ProductReviewRepository->ProductReviewRepository: 68b2b2b2. OrderBy SortOrder
                        ProductReviewRepository-->ProductReviewService: 69b2b2b2. Return sorted MediaLink list
                        deactivate ProductReviewRepository
                        
                        ProductReviewService->ProductReviewService: 70b2b2b2. Map MediaLink list to ProductReviewImageDTO list
                        ProductReviewService->ProductReviewService: 71b2b2b2. Set responseDto.Images
                        ProductReviewService-->ProductReviewController: 72b2b2b2. Return ProductReviewResponseDTO
                        deactivate ProductReviewService
                        ProductReviewController->Client: 73b2b2b2. Return 201 Created (ProductReviewResponseDTO)
                        deactivate ProductReviewController
                    end
                end
            end
        end
    end
end
