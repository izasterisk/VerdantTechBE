title Product Category Create Sequence Diagram

participant Client
participant ProductCategoryController
participant ProductCategoryService
participant ProductCategoryRepository
participant Database

Client->ProductCategoryController: 1. POST /api/ProductCategory (ProductCategoryCreateDTO)
activate ProductCategoryController

ProductCategoryController->ProductCategoryController: 2. ValidateModel()
alt Validation Failed
    ProductCategoryController->Client: 3. Return 400 Bad Request
    deactivate ProductCategoryController
else Validation Success
    ProductCategoryController->ProductCategoryService: 4. Call CreateProductCategoryAsync(dto, cancellationToken)
    activate ProductCategoryService
    
    ProductCategoryService->ProductCategoryRepository: 5. IsCategoryNameNotUniqueAsync(name)
    activate ProductCategoryRepository
    ProductCategoryRepository->Database: 6. Query category by name (case-insensitive)
    activate Database
    Database-->ProductCategoryRepository: 7. Return exists status
    deactivate Database
    ProductCategoryRepository-->ProductCategoryService: 8. Return nameExists (bool)
    deactivate ProductCategoryRepository
    
    alt Name Already Exists
        ProductCategoryService->ProductCategoryService: 9a. Throw ArgumentException("Tên danh mục đã tồn tại")
        ProductCategoryService-->ProductCategoryController: 10a. Exception propagated
        ProductCategoryController->ProductCategoryController: 11a. HandleException(ex)
        ProductCategoryController->Client: 12a. Return 400 Bad Request
        deactivate ProductCategoryService
        deactivate ProductCategoryController
    else Name Available
        alt ParentId Provided
            ProductCategoryService->ProductCategoryRepository: 9b1. IsCategoryAlreadySonsAsync(parentId)
            activate ProductCategoryRepository
            ProductCategoryRepository->Database: 10b1. Get parent category by ID
            activate Database
            Database-->ProductCategoryRepository: 11b1. Return parent category
            deactivate Database
            alt Parent Not Found or Inactive
                ProductCategoryRepository->ProductCategoryRepository: 12b1a. Throw KeyNotFoundException
                ProductCategoryRepository-->ProductCategoryService: 13b1a. Exception propagated
                deactivate ProductCategoryRepository
                ProductCategoryService-->ProductCategoryController: 14b1a. Exception propagated
                ProductCategoryController->ProductCategoryController: 15b1a. HandleException(ex)
                ProductCategoryController->Client: 16b1a. Return 404 Not Found
                deactivate ProductCategoryService
                deactivate ProductCategoryController
            else Parent Exists
                ProductCategoryRepository->ProductCategoryRepository: 12b1b. Check if parent.ParentId != null
                alt Parent Already Has Parent (max 1 level exceeded)
                    ProductCategoryRepository-->ProductCategoryService: 13b1b1. Return true (is already sons)
                    deactivate ProductCategoryRepository
                    ProductCategoryService->ProductCategoryService: 14b1b1. Throw KeyNotFoundException("Cha đang là con của mục khác")
                    ProductCategoryService-->ProductCategoryController: 15b1b1. Exception propagated
                    ProductCategoryController->ProductCategoryController: 16b1b1. HandleException(ex)
                    ProductCategoryController->Client: 17b1b1. Return 404 Not Found
                    deactivate ProductCategoryService
                    deactivate ProductCategoryController
                else Parent Is Root (valid)
                    ProductCategoryRepository-->ProductCategoryService: 13b1b2. Return false
                    deactivate ProductCategoryRepository
                end
            end
        end
        
        ProductCategoryService->ProductCategoryService: 9b2. Generate slug from name
        ProductCategoryService->ProductCategoryService: 10b2. Map DTO to ProductCategory entity
        ProductCategoryService->ProductCategoryService: 11b2. Set entity.Slug
        ProductCategoryService->ProductCategoryRepository: 12b2. CreateProductCategoryAsync(entity)
        activate ProductCategoryRepository
        ProductCategoryRepository->Database: 13b2. INSERT product category
        activate Database
        Database-->ProductCategoryRepository: 14b2. Return created entity
        deactivate Database
        ProductCategoryRepository-->ProductCategoryService: 15b2. Return ProductCategory
        deactivate ProductCategoryRepository
        ProductCategoryService->ProductCategoryService: 16b2. Map ProductCategory to ProductCategoryResponseDTO
        ProductCategoryService-->ProductCategoryController: 17b2. Return ProductCategoryResponseDTO
        deactivate ProductCategoryService
        ProductCategoryController->Client: 18b2. Return 201 Created (ProductCategoryResponseDTO)
        deactivate ProductCategoryController
    end
end

note over Client,Database: Max depth: 1 level (Parent -> Child only)\nCategory name must be unique (case-insensitive)
