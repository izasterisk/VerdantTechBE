title Product Category Update Sequence Diagram

participant Client
participant ProductCategoryController
participant ProductCategoryService
participant ProductCategoryRepository
participant Database

Client->ProductCategoryController: 1. PATCH /api/ProductCategory/{id} (ProductCategoryUpdateDTO)
activate ProductCategoryController

ProductCategoryController->ProductCategoryController: 2. ValidateModel()
alt Validation Failed
    ProductCategoryController->Client: 3. Return 400 Bad Request
    deactivate ProductCategoryController
else Validation Success
    ProductCategoryController->ProductCategoryService: 4. Call UpdateProductCategoryAsync(id, dto, cancellationToken)
    activate ProductCategoryService
    
    ProductCategoryService->ProductCategoryRepository: 5. GetProductCategoryByIdAsync(id, useNoTracking: false)
    activate ProductCategoryRepository
    ProductCategoryRepository->Database: 6. Query category by ID (with tracking)
    activate Database
    Database-->ProductCategoryRepository: 7. Return category or null
    deactivate Database
    ProductCategoryRepository-->ProductCategoryService: 8. Return ProductCategory or null
    deactivate ProductCategoryRepository
    
    alt Category Not Found or Inactive
        ProductCategoryService->ProductCategoryService: 9a. Throw KeyNotFoundException("Không tìm thấy danh mục")
        ProductCategoryService-->ProductCategoryController: 10a. Exception propagated
        ProductCategoryController->ProductCategoryController: 11a. HandleException(ex)
        ProductCategoryController->Client: 12a. Return 404 Not Found
        deactivate ProductCategoryService
        deactivate ProductCategoryController
    else Category Found and Active
        alt Name is Changed (dto.Name != null)
            ProductCategoryService->ProductCategoryRepository: 9b1. IsCategoryNameNotUniqueAsync(dto.Name)
            activate ProductCategoryRepository
            ProductCategoryRepository->Database: 10b1. Query category by name
            activate Database
            Database-->ProductCategoryRepository: 11b1. Return exists status
            deactivate Database
            ProductCategoryRepository-->ProductCategoryService: 12b1. Return nameExists (bool)
            deactivate ProductCategoryRepository
            alt Name Already Exists
                ProductCategoryService->ProductCategoryService: 13b1a. Throw ArgumentException("Tên danh mục đã tồn tại")
                ProductCategoryService-->ProductCategoryController: 14b1a. Exception propagated
                ProductCategoryController->ProductCategoryController: 15b1a. HandleException(ex)
                ProductCategoryController->Client: 16b1a. Return 400 Bad Request
                deactivate ProductCategoryService
                deactivate ProductCategoryController
            else Name Available
                ProductCategoryService->ProductCategoryService: 13b1b. Generate new slug from name
                ProductCategoryService->ProductCategoryService: 14b1b. Set category.Slug
            end
        end
        
        alt ParentId is Changed (dto.ParentId != null)
            ProductCategoryService->ProductCategoryRepository: 9b2. IsCategoryAlreadySonsAsync(dto.ParentId)
            activate ProductCategoryRepository
            ProductCategoryRepository->Database: 10b2. Get parent category by ID
            activate Database
            Database-->ProductCategoryRepository: 11b2. Return parent category
            deactivate Database
            alt Parent Not Found or Inactive
                ProductCategoryRepository->ProductCategoryRepository: 12b2a. Throw KeyNotFoundException("Danh mục cha không tồn tại")
                ProductCategoryRepository-->ProductCategoryService: 13b2a. Exception propagated
                deactivate ProductCategoryRepository
                ProductCategoryService-->ProductCategoryController: 14b2a. Exception propagated
                ProductCategoryController->ProductCategoryController: 15b2a. HandleException(ex)
                ProductCategoryController->Client: 16b2a. Return 404 Not Found
                deactivate ProductCategoryService
                deactivate ProductCategoryController
            else Parent Exists
                alt Parent Already Has Parent (max depth exceeded)
                    ProductCategoryRepository-->ProductCategoryService: 12b2b1. Return true
                    deactivate ProductCategoryRepository
                    ProductCategoryService->ProductCategoryService: 13b2b1. Throw KeyNotFoundException("Cha đang là con của mục khác")
                    ProductCategoryService-->ProductCategoryController: 14b2b1. Exception propagated
                    ProductCategoryController->ProductCategoryController: 15b2b1. HandleException(ex)
                    ProductCategoryController->Client: 16b2b1. Return 404 Not Found
                    deactivate ProductCategoryService
                    deactivate ProductCategoryController
                else Parent Is Root
                    ProductCategoryRepository-->ProductCategoryService: 12b2b2. Return false
                    deactivate ProductCategoryRepository
                    ProductCategoryService->ProductCategoryService: 13b2b2. Check if ParentId == category.Id
                    alt Self Reference Detected
                        ProductCategoryService->ProductCategoryService: 14b2b2a. Throw ArgumentException("Parent ID giống chính ID của nó")
                        ProductCategoryService-->ProductCategoryController: 15b2b2a. Exception propagated
                        ProductCategoryController->ProductCategoryController: 16b2b2a. HandleException(ex)
                        ProductCategoryController->Client: 17b2b2a. Return 400 Bad Request
                        deactivate ProductCategoryService
                        deactivate ProductCategoryController
                    end
                end
            end
        end
        
        ProductCategoryService->ProductCategoryService: 9b3. Map DTO properties to category entity
        ProductCategoryService->ProductCategoryRepository: 10b3. UpdateProductCategoryAsync(category)
        activate ProductCategoryRepository
        ProductCategoryRepository->Database: 11b3. UPDATE category
        activate Database
        Database-->ProductCategoryRepository: 12b3. Return updated entity
        deactivate Database
        ProductCategoryRepository-->ProductCategoryService: 13b3. Return ProductCategory
        deactivate ProductCategoryRepository
        ProductCategoryService->ProductCategoryService: 14b3. Map ProductCategory to ProductCategoryResponseDTO
        ProductCategoryService-->ProductCategoryController: 15b3. Return ProductCategoryResponseDTO
        deactivate ProductCategoryService
        ProductCategoryController->Client: 16b3. Return 200 OK (ProductCategoryResponseDTO)
        deactivate ProductCategoryController
    end
end

note over Client,Database: Partial update: only changed fields are validated\nMax depth: 1 level, no self-reference allowed
