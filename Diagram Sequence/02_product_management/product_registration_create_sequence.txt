title Product Registration Create Sequence Diagram

participant Vendor
participant ProductRegistrationController
participant ProductRegistrationService
participant CloudinaryService
participant Database
participant ProductRegistrationRepository
participant MediaLinkRepository

Vendor->ProductRegistrationController: POST /api/ProductRegistrations (multipart/form-data)
activate ProductRegistrationController

note over ProductRegistrationController: Form: Data (JSON), ManualFile, Images[], Certificate[]

ProductRegistrationController->ProductRegistrationController: Parse form data
ProductRegistrationController->ProductRegistrationController: Upload files to Cloudinary

opt Manual File Provided
    ProductRegistrationController->CloudinaryService: UploadAsync(manualFile, "product-registrations/manuals")
    activate CloudinaryService
    CloudinaryService->CloudinaryService: Upload to Cloudinary
    CloudinaryService-->ProductRegistrationController: (manualUrl, manualPublicUrl)
    deactivate CloudinaryService
end

opt Images Provided
    ProductRegistrationController->CloudinaryService: UploadManyAsync(images, "product-registrations/images")
    activate CloudinaryService
    CloudinaryService->CloudinaryService: Upload all images to Cloudinary
    CloudinaryService-->ProductRegistrationController: List<(url, publicId)>
    deactivate CloudinaryService
    
    ProductRegistrationController->ProductRegistrationController: Convert to MediaLinkItemDTO list
end

opt Certificates Provided
    ProductRegistrationController->ProductRegistrationController: Filter PDF files only
    ProductRegistrationController->CloudinaryService: UploadManyAsync(certificates, "product-registrations/certificates")
    activate CloudinaryService
    CloudinaryService->CloudinaryService: Upload PDFs to Cloudinary
    CloudinaryService-->ProductRegistrationController: List<(url, publicId)>
    deactivate CloudinaryService
    
    ProductRegistrationController->ProductRegistrationController: Convert to MediaLinkItemDTO list (Purpose: CertificatePdf)
end

ProductRegistrationController->ProductRegistrationService: CreateAsync(dto, manualUrl, manualPublicUrl, imagesDto, certDtos)
activate ProductRegistrationService

ProductRegistrationService->Database: Check if Vendor exists
Database-->ProductRegistrationService: Vendor exists (bool)
alt Vendor Not Found
    ProductRegistrationService-->ProductRegistrationController: InvalidOperationException("Vendor not found")
    ProductRegistrationController->Vendor: 400 Bad Request
    deactivate ProductRegistrationService
    deactivate ProductRegistrationController
else Vendor Found
    ProductRegistrationService->Database: Check if Category exists
    Database-->ProductRegistrationService: Category exists (bool)
    alt Category Not Found
        ProductRegistrationService-->ProductRegistrationController: InvalidOperationException("Category not found")
        ProductRegistrationController->Vendor: 400 Bad Request
        deactivate ProductRegistrationService
        deactivate ProductRegistrationController
    else Category Found
        ProductRegistrationService->ProductRegistrationService: Validate EnergyEfficiencyRating (0-5)
        alt Rating Invalid
            ProductRegistrationService-->ProductRegistrationController: InvalidOperationException("Rating must be 0-5")
            ProductRegistrationController->Vendor: 400 Bad Request
            deactivate ProductRegistrationService
            deactivate ProductRegistrationController
        else Rating Valid
            ProductRegistrationService->ProductRegistrationService: Validate DimensionsCm
            alt Dimensions Invalid
                ProductRegistrationService-->ProductRegistrationController: InvalidOperationException("Invalid dimensions")
                ProductRegistrationController->Vendor: 400 Bad Request
                deactivate ProductRegistrationService
                deactivate ProductRegistrationController
            else Dimensions Valid
                ProductRegistrationService->ProductRegistrationService: Map DTO to ProductRegistration entity
                ProductRegistrationService->ProductRegistrationService: Set Status = Pending
                ProductRegistrationService->ProductRegistrationService: Set ManualUrls, PublicUrl
                ProductRegistrationService->ProductRegistrationService: Convert Specifications to Dictionary
                ProductRegistrationService->ProductRegistrationService: Convert DimensionsCm to Dictionary
                
                ProductRegistrationService->ProductRegistrationService: Convert images to MediaLink entities (OwnerType: ProductRegistrations)
                ProductRegistrationService->ProductRegistrationService: Convert certificates to MediaLink entities (OwnerType: ProductCertificates)
                
                ProductRegistrationService->ProductRegistrationRepository: CreateAsync(registration, productImages, certificateImages)
                activate ProductRegistrationRepository
                ProductRegistrationRepository->Database: BEGIN TRANSACTION
                ProductRegistrationRepository->Database: INSERT INTO product_registrations (vendor_id, category_id, proposed_product_code, proposed_product_name, status, ...)
                Database-->ProductRegistrationRepository: Registration created with ID
                ProductRegistrationRepository->Database: INSERT INTO media_links (owner_type, owner_id, image_public_id, ...) VALUES ... (for images)
                Database-->ProductRegistrationRepository: Images inserted
                ProductRegistrationRepository->Database: INSERT INTO media_links (owner_type, owner_id, image_public_id, ...) VALUES ... (for certificates)
                Database-->ProductRegistrationRepository: Certificates inserted
                ProductRegistrationRepository->Database: COMMIT TRANSACTION
                ProductRegistrationRepository-->ProductRegistrationService: Created ProductRegistration
                deactivate ProductRegistrationRepository
                
                ProductRegistrationService->Database: Reload registration with relations
                Database-->ProductRegistrationService: Fresh ProductRegistration entity
                
                ProductRegistrationService->ProductRegistrationService: HydrateMediaAsync (load images and certificates)
                ProductRegistrationService->MediaLinkRepository: Get product images
                MediaLinkRepository->Database: SELECT * FROM media_links WHERE owner_type = 'ProductRegistrations' AND owner_id = ?
                Database-->MediaLinkRepository: Product images
                MediaLinkRepository-->ProductRegistrationService: Images
                
                ProductRegistrationService->MediaLinkRepository: Get certificates
                MediaLinkRepository->Database: SELECT * FROM media_links WHERE owner_type = 'ProductCertificates' AND owner_id = ?
                Database-->MediaLinkRepository: Certificates
                MediaLinkRepository-->ProductRegistrationService: Certificates
                
                ProductRegistrationService->ProductRegistrationService: Map to ProductRegistrationReponseDTO with images and certificates
                ProductRegistrationService-->ProductRegistrationController: ProductRegistrationReponseDTO
                deactivate ProductRegistrationService
                
                ProductRegistrationController->Vendor: 200 OK (ProductRegistrationReponseDTO)
                deactivate ProductRegistrationController
            end
        end
    end
end

