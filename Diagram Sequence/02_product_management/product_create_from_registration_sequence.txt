title Create Product from Registration Sequence Diagram

participant Client
participant ProductRegistrationController
participant ProductRegistrationService
participant Database

note over Client,Database: Admin approves ProductRegistration to create Product

Client->ProductRegistrationController: 1. PATCH /api/ProductRegistration/{id}/status (ChangeStatusDTO)
activate ProductRegistrationController

note over ProductRegistrationController: Body: { status: "Approved", approvedBy: adminId, rejectionReason: null }

ProductRegistrationController->ProductRegistrationService: 2. ChangeStatusAsync(id, status, rejectionReason, approvedBy, ct)
activate ProductRegistrationService

ProductRegistrationService->Database: 3. SELECT ProductRegistration WHERE id = ?
activate Database
Database-->ProductRegistrationService: 4. Return registration or null
deactivate Database

alt Registration Not Found
    ProductRegistrationService->ProductRegistrationService: 5a. Throw InvalidOperationException("Đơn đăng ký không tồn tại")
    ProductRegistrationService-->ProductRegistrationController: 6a. Exception propagated
    ProductRegistrationController->ProductRegistrationController: 7a. HandleException(ex)
    ProductRegistrationController->Client: 8a. Return 400 Bad Request
    deactivate ProductRegistrationService
    deactivate ProductRegistrationController
else Registration Found
    alt Already Approved
        ProductRegistrationService->ProductRegistrationService: 5b1. Throw InvalidOperationException("Đơn đăng ký đã được duyệt trước đó")
        ProductRegistrationService-->ProductRegistrationController: 6b1. Exception propagated
        ProductRegistrationController->ProductRegistrationController: 7b1. HandleException(ex)
        ProductRegistrationController->Client: 8b1. Return 400 Bad Request
        deactivate ProductRegistrationService
        deactivate ProductRegistrationController
    else Already Rejected
        ProductRegistrationService->ProductRegistrationService: 5b2. Throw InvalidOperationException("Đơn đăng ký đã bị từ chối trước đó")
        ProductRegistrationService-->ProductRegistrationController: 6b2. Exception propagated
        ProductRegistrationController->ProductRegistrationController: 7b2. HandleException(ex)
        ProductRegistrationController->Client: 8b2. Return 400 Bad Request
        deactivate ProductRegistrationService
        deactivate ProductRegistrationController
    else Can Process
        ProductRegistrationService->ProductRegistrationService: 5b3. Set UpdatedAt = DateTime.UtcNow
        ProductRegistrationService->Database: 6b3. BEGIN TRANSACTION
        activate Database
        ProductRegistrationService->ProductRegistrationService: 7b3. Set Status = Approved
        ProductRegistrationService->ProductRegistrationService: 8b3. Set ApprovedBy, ApprovedAt
        ProductRegistrationService->ProductRegistrationService: 9b3. Set RejectionReason = null
        ProductRegistrationService->Database: 10b3. SaveChangesAsync() - Update registration
        Database-->ProductRegistrationService: 11b3. Registration updated
        
        ProductRegistrationService->ProductRegistrationService: 12b3. Generate unique ProductCode (check duplicates)
        ProductRegistrationService->Database: 13b3. Check if ProductCode exists
        activate Database
        Database-->ProductRegistrationService: 14b3. Return exists status
        deactivate Database
        
        ProductRegistrationService->ProductRegistrationService: 15b3. Generate unique Slug (Slugify + check duplicates)
        ProductRegistrationService->Database: 16b3. Check if Slug exists
        activate Database
        Database-->ProductRegistrationService: 17b3. Return exists status
        deactivate Database
        
        ProductRegistrationService->ProductRegistrationService: 18b3. Map ProductRegistration to Product
        ProductRegistrationService->ProductRegistrationService: 19b3. Set Product.ProductCode (unique)
        ProductRegistrationService->ProductRegistrationService: 20b3. Set Product.Slug (unique)
        ProductRegistrationService->ProductRegistrationService: 21b3. Set IsActive = true, CreatedAt, UpdatedAt
        ProductRegistrationService->Database: 22b3. Add Product to DbSet
        ProductRegistrationService->Database: 23b3. SaveChangesAsync() - Insert Product
        Database-->ProductRegistrationService: 24b3. Product created with ID
        
        ProductRegistrationService->Database: 25b3. SELECT MediaLinks (OwnerType=ProductRegistrations, OwnerId=reg.Id)
        activate Database
        Database-->ProductRegistrationService: 26b3. Return registration images
        deactivate Database
        
        alt Registration Has Images
            ProductRegistrationService->ProductRegistrationService: 27b3a. Clone MediaLinks (OwnerType=Products, OwnerId=product.Id)
            ProductRegistrationService->Database: 28b3a. AddRange cloned MediaLinks
            ProductRegistrationService->Database: 29b3a. SaveChangesAsync() - Insert images
            activate Database
            Database-->ProductRegistrationService: 30b3a. Images copied
            deactivate Database
        end
        
        ProductRegistrationService->Database: 31b3. SELECT ProductCertificates (RegistrationId=reg.Id)
        activate Database
        Database-->ProductRegistrationService: 32b3. Return registration certificates
        deactivate Database
        
        alt Registration Has Certificates
            ProductRegistrationService->ProductRegistrationService: 33b3a. Loop through certificates
            ProductRegistrationService->ProductRegistrationService: 34b3a. Create new ProductCertificate (ProductId=product.Id)
            ProductRegistrationService->ProductRegistrationService: 35b3a. Set Status=Verified, VerifiedBy, VerifiedAt
            ProductRegistrationService->Database: 36b3a. Add ProductCertificate
            ProductRegistrationService->Database: 37b3a. SaveChangesAsync() - Insert certificate
            activate Database
            Database-->ProductRegistrationService: 38b3a. Certificate created with ID
            deactivate Database
            
            ProductRegistrationService->Database: 39b3a. SELECT MediaLinks (OwnerType=ProductCertificates, OwnerId=old cert Id)
            activate Database
            Database-->ProductRegistrationService: 40b3a. Return certificate files
            deactivate Database
            
            alt Certificate Has Files
                ProductRegistrationService->ProductRegistrationService: 41b3a1. Clone certificate MediaLinks (OwnerId=newCert.Id)
                ProductRegistrationService->Database: 42b3a1. AddRange cloned certificate files
                ProductRegistrationService->Database: 43b3a1. SaveChangesAsync() - Insert cert files
                activate Database
                Database-->ProductRegistrationService: 44b3a1. Certificate files copied
                deactivate Database
            end
        end
        
        ProductRegistrationService->Database: 45b3. SELECT User (vendor) WHERE Id = reg.VendorId
        activate Database
        Database-->ProductRegistrationService: 46b3. Return vendor
        deactivate Database
        
        alt Vendor Found
            ProductRegistrationService->ProductRegistrationService: 47b3a. SendProductRegistrationApprovedEmailAsync()
            note over ProductRegistrationService: Email sent asynchronously (error ignored)
        end
        
        ProductRegistrationService->Database: 48b3. COMMIT TRANSACTION
        Database-->ProductRegistrationService: 49b3. Transaction committed
        deactivate Database
        
        ProductRegistrationService-->ProductRegistrationController: 50b3. Return true
        deactivate ProductRegistrationService
        ProductRegistrationController->Client: 51b3. Return 204 No Content
        deactivate ProductRegistrationController
    end
end
end

note over Client,Database: Approved registration creates Product with all images/certificates\nUnique ProductCode and Slug are auto-generated

