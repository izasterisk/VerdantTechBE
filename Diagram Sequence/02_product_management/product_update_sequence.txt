title Update Product Sequence Diagram

participant Vendor
participant ProductUI
participant ProductController
participant ProductService
participant ProductRepository
participant Database

Vendor->ProductUI: 1. Update product (id, dto, addImages, removeImagePublicIds)
ProductUI->ProductController: 2. PUT /api/Product/{id} (UpdateRequest)
activate ProductController

ProductController->ProductController: 3. ValidateModel()
alt Validation Failed
    ProductController->ProductUI: 4.1 Return 400 Bad Request
    ProductUI->Vendor: 5.1 Show error message
    deactivate ProductController
else Validation Success
    ProductController->ProductService: 4.2 Call UpdateAsync(id, dto, addImages, removeImagePublicIds)
    activate ProductService
    
    ProductService->ProductRepository: 5.2 GetProductByIdAsync(id, useNoTracking: false)
    activate ProductRepository
    ProductRepository->Database: 6.2 Check if product exists
    Database-->ProductRepository: 7.2 Return product data
    ProductRepository-->ProductService: 8.2 Return product or null
    deactivate ProductRepository
    
    alt Product Not Found
        ProductService-->ProductController: 7.1 Return failure message
        ProductController->ProductUI: 8.1 Return 404 Not Found
        ProductUI->Vendor: 9.1 Show error message
        deactivate ProductService
        deactivate ProductController
    else Product Found
        ProductService->ProductService: 9.2 Update product fields
        ProductService->ProductRepository: 10.2 UpdateProductAsync(entity)
        activate ProductRepository
        ProductRepository->Database: 11.2 Update product information
        Database-->ProductRepository: 12.2 Return update result
        ProductRepository-->ProductService: 13.2 Return updated product
        deactivate ProductRepository
        opt Remove Images Requested
            ProductService->Database: 14.2 Remove images
            Database-->ProductService: 15.2 Return remove result
        end
        opt Add Images Requested
            ProductService->Database: 16.2 Add new images
            Database-->ProductService: 17.2 Return add result
        end
        ProductService->ProductService: 18.2 Load product images
        ProductService-->ProductController: 19.2 Return success message (ProductResponseDTO)
        deactivate ProductService
        ProductController->ProductUI: 20.2 Return 200 OK (ProductResponseDTO)
        deactivate ProductController
        ProductUI->Vendor: 21.2 Display updated product
    end
end
