title Create Refund Request Sequence Diagram

participant Client
participant RequestTicketController
participant RequestService
participant UserRepository
participant RequestRepository
participant Database

Client->RequestTicketController: 1. POST /api/RequestTicket (RequestCreateDTO)
activate RequestTicketController

RequestTicketController->RequestTicketController: 2. ValidateModel()
alt Validation Failed
    RequestTicketController->Client: 3. Return 400 Bad Request
    deactivate RequestTicketController
else Validation Success
    RequestTicketController->RequestTicketController: 4. GetCurrentUserId() (from JWT)
    RequestTicketController->RequestService: 5. CreateRequestAsync(userId, dto, ct)
    activate RequestService
    
    RequestService->UserRepository: 6. GetVerifiedAndActiveUserByIdAsync(userId)
    activate UserRepository
    UserRepository->Database: 7. Query user (verified + active)
    activate Database
    Database-->UserRepository: 8. Return user or null
    deactivate Database
    alt User Not Found or Invalid
        UserRepository->UserRepository: 9a. Throw exception
        UserRepository-->RequestService: 10a. Exception propagated
        deactivate UserRepository
        RequestService-->RequestTicketController: 11a. Exception propagated
        RequestTicketController->RequestTicketController: 12a. HandleException(ex)
        RequestTicketController->Client: 13a. Return 404 Not Found
        deactivate RequestService
        deactivate RequestTicketController
    else User Valid
        UserRepository-->RequestService: 9b. Return user
        deactivate UserRepository
    end
    
    RequestService->RequestService: 10b. Map DTO to Request entity
    RequestService->RequestService: 11b. Set request.UserId = userId
    RequestService->RequestService: 12b. Set request.Status = Pending
    RequestService->RequestService: 13b. Create RequestMessage with description
    RequestService->RequestService: 14b. Map images to MediaLink entities
    RequestService->RequestRepository: 15b. CreateRequestWithTransactionAsync(request, message, images)
    activate RequestRepository
    RequestRepository->Database: 16b. Begin Transaction
    activate Database
    RequestRepository->Database: 17b. INSERT request
    Database-->RequestRepository: 18b. Return created request
    RequestRepository->Database: 19b. INSERT request_message
    Database-->RequestRepository: 20b. Return created message
    alt Has Images
        RequestRepository->Database: 21b1. INSERT media_links (batch)
        Database-->RequestRepository: 22b1. Images inserted
    end
    RequestRepository->Database: 21b2. Commit Transaction
    Database-->RequestRepository: 22b2. Transaction committed
    deactivate Database
    RequestRepository-->RequestService: 23b. Return created request
    deactivate RequestRepository
    
    RequestService->RequestRepository: 24b. GetRequestByIdWithRelationsAsync(requestId)
    activate RequestRepository
    RequestRepository->Database: 25b. Query request with all relations
    activate Database
    Database-->RequestRepository: 26b. Return request data
    deactivate Database
    RequestRepository-->RequestService: 27b. Return request
    deactivate RequestRepository
    
    RequestService->RequestService: 28b. Map to RequestResponseDTO
    RequestService->RequestService: 29b. Loop through requestMessages
    RequestService->RequestRepository: 30b. GetAllImagesByRequestMessageIdAsync(messageId)
    activate RequestRepository
    RequestRepository->Database: 31b. Query media_links by message ID
    activate Database
    Database-->RequestRepository: 32b. Return images list
    deactivate Database
    RequestRepository-->RequestService: 33b. Return images
    deactivate RequestRepository
    RequestService->RequestService: 34b. Populate images to response
    
    RequestService-->RequestTicketController: 35b. Return RequestResponseDTO
    deactivate RequestService
    RequestTicketController->Client: 36b. Return 201 Created (RequestResponseDTO)
    deactivate RequestTicketController
end

note over Client,Database: Creates refund/support request with initial message and images\nTransaction includes: request + message + images\nStatus starts as Pending

