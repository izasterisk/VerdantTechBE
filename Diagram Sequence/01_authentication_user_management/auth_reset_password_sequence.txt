title Reset Password Sequence Diagram

participant User
participant ResetPasswordUI
participant AuthController
participant AuthService
participant AuthRepository
participant AuthValidationHelper
participant Database

User->ResetPasswordUI: 1. Enter email, code, and new password
User->ResetPasswordUI: 2. Click "Xác nhận" or "Đặt lại mật khẩu" button
ResetPasswordUI->AuthController: 3. POST /api/Auth/reset-password (ResetForgotPasswordDTO)
activate AuthController

AuthController->AuthController: 4. ValidateModel()
alt Validation Failed
    AuthController->ResetPasswordUI: 5.1 Return 400 Bad Request
    ResetPasswordUI->User: 6.1 Show validation error
    deactivate AuthController
else Validation Success
    AuthController->AuthService: 5.2 Call UpdateForgotPasswordAsync(email, newPassword, code)
    activate AuthService
    
    AuthService->AuthRepository: 6.2 GetUserByEmailAsync(email)
    activate AuthRepository
    AuthRepository->Database: 7.2 Check if user exists
    Database-->AuthRepository: 8.2 Return user data or null
    AuthRepository-->AuthService: 9.2 Return user or null
    deactivate AuthRepository
    
    alt User Not Found
        AuthService-->AuthController: 10.2.1 Throw InvalidOperationException
        AuthController->ResetPasswordUI: 11.2.1 Return 400 Bad Request
        ResetPasswordUI->User: 12.2.1 Show error message
        deactivate AuthService
        deactivate AuthController
    else User Found
        AuthService->AuthValidationHelper: 10.2.2 ValidateResetPasswordCode(user, code)
        activate AuthValidationHelper
        AuthValidationHelper->AuthValidationHelper: 11.2.2 Check if code matches and not expired
        alt Code Invalid or Expired
            AuthValidationHelper-->AuthService: 12.2.2.1 Throw ArgumentException or InvalidOperationException
            AuthService-->AuthController: 13.2.2.1 Throw exception
            AuthController->ResetPasswordUI: 14.2.2.1 Return 400 Bad Request
            ResetPasswordUI->User: 15.2.2.1 Show error message (invalid code or expired)
            deactivate AuthValidationHelper
            deactivate AuthService
            deactivate AuthController
        else Code Valid
            AuthValidationHelper-->AuthService: 12.2.2.2 Return validation success
            deactivate AuthValidationHelper
            
            AuthService->AuthValidationHelper: 13.2.2.2 ValidateUserStatus(user)
            activate AuthValidationHelper
            AuthValidationHelper->AuthValidationHelper: 14.2.2.2 Check user status
            alt User Status Invalid
                AuthValidationHelper-->AuthService: 15.2.2.2.1 Throw InvalidOperationException
                AuthService-->AuthController: 16.2.2.2.1 Throw exception
                AuthController->ResetPasswordUI: 17.2.2.2.1 Return 400 Bad Request
                ResetPasswordUI->User: 18.2.2.2.1 Show error message
                deactivate AuthValidationHelper
                deactivate AuthService
                deactivate AuthController
            else User Status Valid
                AuthValidationHelper-->AuthService: 15.2.2.2.2 Return validation success
                deactivate AuthValidationHelper
                
                AuthService->AuthService: 16.2.2.2.2 HashPassword(newPassword)
                AuthService->AuthRepository: 17.2.2.2.2 UpdateUserAsync(user with new PasswordHash)
                activate AuthRepository
                AuthRepository->Database: 18.2.2.2.2 Update user password hash
                Database-->AuthRepository: 19.2.2.2.2 Return update result
                AuthRepository-->AuthService: 20.2.2.2.2 Return update confirmation
                deactivate AuthRepository
                
                AuthService-->AuthController: 21.2.2.2.2 Return success
                deactivate AuthService
                AuthController->ResetPasswordUI: 22.2.2.2.2 Return 200 OK ("Password reset successfully")
                deactivate AuthController
                ResetPasswordUI->User: 23.2.2.2.2 Show success message and redirect to login page
            end
        end
    end
end

