title Update User Sequence Diagram

participant Client
participant UserController
participant UserService
participant UserRepository
participant Database

Client->UserController: 1. PATCH /api/User/{id} (UserUpdateDTO)
activate UserController

note over UserController: Requires Authorization

UserController->UserController: 2. ValidateModel()
alt Validation Failed
    UserController->Client: 3a. Return 400 Bad Request
    deactivate UserController
else Validation Success
    UserController->UserService: 3b. Call UpdateUserAsync(id, dto, cancellationToken)
    activate UserService
    
    UserService->UserRepository: 4b. GetUserWithAddressesByIdAsync(userId, cancellationToken)
    activate UserRepository
    UserRepository->Database: 5b. Query user by ID with addresses
    activate Database
    Database-->UserRepository: 6b. Return user data or null
    deactivate Database
    UserRepository-->UserService: 7b. Return user or null
    deactivate UserRepository
    
    alt User Not Found
        UserService->UserService: 8b1. Throw Exception("User with ID {userId} not found")
        UserService-->UserController: 9b1. Exception propagated
        AuthController->AuthController: 10b1. HandleException(ex)
        UserController->Client: 11b1. Return 500 Internal Server Error
        deactivate UserService
        deactivate UserController
    else User Found
        alt Status Update Requested
            alt User Already Deleted
                UserService->UserService: 8b2a. Throw InvalidOperationException("Tài khoản này đã bị xóa")
                UserService-->UserController: 9b2a. Exception propagated
                UserController->UserController: 10b2a. HandleException(ex)
                UserController->Client: 11b2a. Return 400 Bad Request
                deactivate UserService
                deactivate UserController
            else Status Not Deleted
                alt Status Changed
                    UserService->UserService: 8b2b1. Set existingUser.Status = dto.Status
                    alt Status = Deleted
                        UserService->UserService: 9b2b1. Set existingUser.DeletedAt = DateTime.UtcNow
                    end
                end
            end
        end
        
        UserService->UserService: 10b2b. Map DTO to existingUser
        UserService->UserRepository: 11b2b. UpdateUserWithTransactionAsync(existingUser, cancellationToken)
        activate UserRepository
        UserRepository->Database: 12b2b. Begin Transaction
        activate Database
        UserRepository->UserRepository: 13b2b. Set UpdatedAt = DateTime.UtcNow
        UserRepository->Database: 14b2b. UPDATE user
        Database-->UserRepository: 15b2b. Return update result
        UserRepository->Database: 16b2b. Commit Transaction
        Database-->UserRepository: 17b2b. Transaction committed
        deactivate Database
        UserRepository-->UserService: 18b2b. Return updated user
        deactivate UserRepository
        UserService->UserService: 19b2b. Map User to UserResponseDTO
        UserService-->UserController: 20b2b. Return UserResponseDTO
        deactivate UserService
        UserController->Client: 21b2b. Return 200 OK (UserResponseDTO)
        deactivate UserController
    end
end

note over Client,Database: Can update user info including status\nStatus change to Deleted sets DeletedAt timestamp

