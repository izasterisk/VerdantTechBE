title Send Verification Email Sequence Diagram

participant Client
participant AuthController
participant AuthService
participant AuthRepository
participant EmailSender
participant Database

Client->AuthController: 1. POST /api/Auth/send-verification (SendEmailDTO)
activate AuthController

AuthController->AuthController: 2. ValidateModel()
alt Validation Failed
    AuthController->Client: 3. Return 400 Bad Request
    deactivate AuthController
else Validation Success
    AuthController->AuthService: 4. Call SendVerificationEmailAsync(email, cancellationToken)
    activate AuthService
    
    AuthService->AuthRepository: 5. GetUserByEmailAsync(email)
    activate AuthRepository
    AuthRepository->Database: 6. Query user by email
    activate Database
    Database-->AuthRepository: 7. Return user data or null
    deactivate Database
    AuthRepository-->AuthService: 8. Return user or null
    deactivate AuthRepository
    
    alt User Not Found
        AuthService->AuthService: 9a. Throw InvalidOperationException("User not found")
        AuthService-->AuthController: 10a. Exception propagated
        AuthController->AuthController: 11a. HandleException(ex)
        AuthController->Client: 12a. Return 400 Bad Request
        deactivate AuthService
        deactivate AuthController
    else User Found
        AuthService->AuthService: 9b. ValidateUserStatus(user)
        alt User Status Invalid (Deleted/Suspended/Inactive)
            AuthService->AuthService: 10b1. Throw UnauthorizedAccessException
            AuthService-->AuthController: 11b1. Exception propagated
            AuthController->AuthController: 12b1. HandleException(ex)
            AuthController->Client: 13b1. Return 401 Unauthorized
            deactivate AuthService
            deactivate AuthController
        else User Status Valid
            alt User Already Verified
                AuthService->AuthService: 10b2a. Throw InvalidOperationException("User already verified")
                AuthService-->AuthController: 11b2a. Exception propagated
                AuthController->AuthController: 12b2a. HandleException(ex)
                AuthController->Client: 13b2a. Return 400 Bad Request
                deactivate AuthService
                deactivate AuthController
            else User Not Verified
                AuthService->AuthService: 10b2b. Generate 8-digit numeric code
                AuthService->EmailSender: 11b2b. SendVerificationEmailAsync(email, fullName, code)
                activate EmailSender
                EmailSender->EmailSender: 12b2b. Compose verification email
                EmailSender->EmailSender: 13b2b. Send email via SMTP
                EmailSender-->AuthService: 14b2b. Email sent successfully
                deactivate EmailSender
                AuthService->AuthService: 15b2b. Set user.VerificationToken = code
                AuthService->AuthService: 16b2b. Set user.VerificationSentAt = DateTime.UtcNow
                AuthService->AuthRepository: 17b2b. UpdateUserAsync(user)
                activate AuthRepository
                AuthRepository->AuthRepository: 18b2b. Set UpdatedAt = DateTime.UtcNow
                AuthRepository->Database: 19b2b. UPDATE user (VerificationToken, VerificationSentAt, UpdatedAt)
                activate Database
                Database-->AuthRepository: 20b2b. Return update result
                deactivate Database
                AuthRepository->Database: 21b2b. SaveChangesAsync()
                activate Database
                Database-->AuthRepository: 22b2b. Changes saved
                deactivate Database
                AuthRepository-->AuthService: 23b2b. Update completed
                deactivate AuthRepository
                AuthService-->AuthController: 24b2b. Task completed
                deactivate AuthService
                AuthController->Client: 25b2b. Return 200 OK ("Verification email sent")
                deactivate AuthController
            end
        end
    end
end

note over Client,Database: Verification code is 8 digits and expires in 10 minutes

