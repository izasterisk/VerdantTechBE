title User Login Sequence Diagram

participant Client
participant AuthController
participant AuthService
participant AuthRepository
participant UserRepository
participant Database

Client->AuthController: 1. POST /api/Auth/login (LoginDTO)
activate AuthController

AuthController->AuthController: 2. ValidateModel()
alt Validation Failed
    AuthController->Client: 3. Return 400 Bad Request
    deactivate AuthController
else Validation Success
    AuthController->AuthService: 4. Call LoginAsync(loginDto, cancellationToken)
    activate AuthService
    
    AuthService->AuthRepository: 5. GetUserWithFarmByEmailAsync(email)
    activate AuthRepository
    AuthRepository->Database: 6. Query user by email with farm profiles
    activate Database
    Database-->AuthRepository: 7. Return user data or null
    deactivate Database
    AuthRepository-->AuthService: 8. Return user or null
    deactivate AuthRepository
    
    alt User Not Found
        AuthService->AuthService: 9a. Throw InvalidOperationException("User not found")
        AuthService-->AuthController: 10a. Exception propagated
        AuthController->AuthController: 11a. HandleException(ex)
        AuthController->Client: 12a. Return 400 Bad Request
        deactivate AuthService
        deactivate AuthController
    else User Found
        AuthService->AuthService: 9b. ValidateUserStatus(user)
        alt User Status Invalid (Deleted/Suspended/Inactive)
            AuthService->AuthService: 10b1. Throw UnauthorizedAccessException
            AuthService-->AuthController: 11b1. Exception propagated
            AuthController->AuthController: 12b1. HandleException(ex)
            AuthController->Client: 13b1. Return 401 Unauthorized
            deactivate AuthService
            deactivate AuthController
        else User Status Valid
            AuthService->AuthService: 10b2. ValidateLoginCredentials(user, password)
            alt Invalid Password or Email Not Verified
                AuthService->AuthService: 11b2a. Throw UnauthorizedAccessException/InvalidOperationException
                AuthService-->AuthController: 12b2a. Exception propagated
                AuthController->AuthController: 13b2a. HandleException(ex)
                AuthController->Client: 14b2a. Return 401/400
                deactivate AuthService
                deactivate AuthController
            else Valid Credentials
                AuthService->AuthService: 11b2b. Clear FarmProfiles from user object
                AuthService->AuthService: 12b2b. Call GenerateTokensAndUpdateUserAsync(user)
                AuthService->AuthService: 13b2b. Generate JWT token
                AuthService->AuthService: 14b2b. Generate refresh token
                AuthService->AuthService: 15b2b. Set user.RefreshToken, RefreshTokenExpiresAt
                AuthService->AuthService: 16b2b. Set user.LastLoginAt, UpdatedAt
                AuthService->UserRepository: 17b2b. UpdateUserWithTransactionAsync(user)
                activate UserRepository
                UserRepository->Database: 18b2b. Begin Transaction
                activate Database
                UserRepository->UserRepository: 19b2b. Set UpdatedAt = DateTime.UtcNow
                UserRepository->Database: 20b2b. UPDATE user (tokens, LastLoginAt, UpdatedAt)
                Database-->UserRepository: 21b2b. Return update result
                UserRepository->Database: 22b2b. Commit Transaction
                Database-->UserRepository: 23b2b. Transaction committed
                deactivate Database
                UserRepository-->AuthService: 24b2b. Return updated user
                deactivate UserRepository
                AuthService->AuthService: 25b2b. Create LoginResponseDTO object
                AuthService-->AuthController: 26b2b. Return LoginResponseDTO
                deactivate AuthService
                AuthController->Client: 27b2b. Return 200 OK (LoginResponseDTO)
                deactivate AuthController
            end
        end
    end
end

