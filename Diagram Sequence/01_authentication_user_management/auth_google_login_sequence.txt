title Google Login Sequence Diagram

participant Client
participant AuthController
participant AuthService
participant GoogleAuthHelper
participant AuthRepository
participant UserRepository
participant Database

Client->AuthController: 1. POST /api/Auth/google-login (GoogleLoginDTO)
activate AuthController

AuthController->AuthController: 2. ValidateModel()
alt Validation Failed
    AuthController->Client: 3. Return 400 Bad Request
    deactivate AuthController
else Validation Success
    AuthController->AuthService: 4. Call GoogleLoginAsync(googleLoginDto, cancellationToken)
    activate AuthService
    
    AuthService->GoogleAuthHelper: 5. ValidateGoogleTokenAsync(idToken)
    activate GoogleAuthHelper
    GoogleAuthHelper->GoogleAuthHelper: 6. Get Google Client ID from env
    alt Google Client ID Not Configured
        GoogleAuthHelper->GoogleAuthHelper: 7a. Throw InvalidOperationException
        GoogleAuthHelper-->AuthService: 8a. Exception propagated
        AuthService-->AuthController: 9a. Exception propagated
        deactivate GoogleAuthHelper
        AuthController->AuthController: 10a. HandleException(ex)
        AuthController->Client: 11a. Return 400 Bad Request
        deactivate AuthService
        deactivate AuthController
    else Google Client ID Configured
        GoogleAuthHelper->GoogleAuthHelper: 7b. Call Google API ValidateAsync(idToken)
        alt Invalid Google Token
            GoogleAuthHelper->GoogleAuthHelper: 8b1. Throw UnauthorizedAccessException
            GoogleAuthHelper-->AuthService: 9b1. Exception propagated
            AuthService-->AuthController: 10b1. Exception propagated
            deactivate GoogleAuthHelper
            AuthController->AuthController: 11b1. HandleException(ex)
            AuthController->Client: 12b1. Return 401 Unauthorized
            deactivate AuthService
            deactivate AuthController
        else Valid Google Token
            GoogleAuthHelper->GoogleAuthHelper: 8b2. Extract payload from Google
            GoogleAuthHelper->GoogleAuthHelper: 9b2. Create GoogleUserInfoDTO
            GoogleAuthHelper-->AuthService: 10b2. Return GoogleUserInfoDTO
            deactivate GoogleAuthHelper
            
            AuthService->AuthRepository: 11b2. GetUserWithFarmByEmailAsync(googleUser.Email)
            activate AuthRepository
            AuthRepository->Database: 12b2. Query user by email with farm profiles
            activate Database
            Database-->AuthRepository: 13b2. Return user data or null
            deactivate Database
            AuthRepository-->AuthService: 14b2. Return user or null
            deactivate AuthRepository
            
            alt User Not Found (New Google User)
                AuthService->GoogleAuthHelper: 15b2a. CreateUserFromGoogleAuth(googleUser)
                activate GoogleAuthHelper
                GoogleAuthHelper->GoogleAuthHelper: 16b2a. Create User object with Google data
                GoogleAuthHelper->GoogleAuthHelper: 17b2a. Set IsVerified = true
                GoogleAuthHelper->GoogleAuthHelper: 18b2a. Set Role = Customer
                GoogleAuthHelper->GoogleAuthHelper: 19b2a. Generate random password hash
                GoogleAuthHelper-->AuthService: 20b2a. Return new User object
                deactivate GoogleAuthHelper
                AuthService->UserRepository: 21b2a. CreateUserWithTransactionAsync(user)
                activate UserRepository
                UserRepository->Database: 22b2a. Begin Transaction
                activate Database
                UserRepository->UserRepository: 23b2a. Set LastLoginAt, CreatedAt, UpdatedAt
                UserRepository->UserRepository: 24b2a. Set Status = Active
                UserRepository->Database: 25b2a. INSERT new user
                Database-->UserRepository: 26b2a. Return insert result
                UserRepository->Database: 27b2a. Commit Transaction
                Database-->UserRepository: 28b2a. Transaction committed
                deactivate Database
                UserRepository-->AuthService: 29b2a. Return created user
                deactivate UserRepository
            else User Already Exists
                AuthService->AuthService: 15b2b. ValidateUserStatus(user)
                alt User Status Invalid (Deleted/Suspended/Inactive)
                    AuthService->AuthService: 16b2b1. Throw UnauthorizedAccessException
                    AuthService-->AuthController: 17b2b1. Exception propagated
                    AuthController->AuthController: 18b2b1. HandleException(ex)
                    AuthController->Client: 19b2b1. Return 401 Unauthorized
                    deactivate AuthService
                    deactivate AuthController
                else User Status Valid
                    AuthService->AuthService: 16b2b2. Clear FarmProfiles from user object
                end
            end
            
            AuthService->AuthService: 30b2. Call GenerateTokensAndUpdateUserAsync(user)
            AuthService->AuthService: 31b2. Generate JWT token
            AuthService->AuthService: 32b2. Generate refresh token
            AuthService->AuthService: 33b2. Set user.RefreshToken, RefreshTokenExpiresAt
            AuthService->AuthService: 34b2. Set user.LastLoginAt, UpdatedAt
            AuthService->UserRepository: 35b2. UpdateUserWithTransactionAsync(user)
            activate UserRepository
            UserRepository->Database: 36b2. Begin Transaction
            activate Database
            UserRepository->UserRepository: 37b2. Set UpdatedAt = DateTime.UtcNow
            UserRepository->Database: 38b2. UPDATE user (tokens, LastLoginAt, UpdatedAt)
            Database-->UserRepository: 39b2. Return update result
            UserRepository->Database: 40b2. Commit Transaction
            Database-->UserRepository: 41b2. Transaction committed
            deactivate Database
            UserRepository-->AuthService: 42b2. Return updated user
            deactivate UserRepository
            AuthService->AuthService: 43b2. Create LoginResponseDTO object
            AuthService-->AuthController: 44b2. Return LoginResponseDTO
            deactivate AuthService
            AuthController->Client: 45b2. Return 200 OK (LoginResponseDTO)
            deactivate AuthController
        end
    end
end

note over Client,Database: Google login auto-creates new user if not exists\nand auto-verifies the account (IsVerified=true)

