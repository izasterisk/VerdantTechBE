title Change Password Sequence Diagram

participant Client
participant AuthController
participant AuthService
participant AuthRepository
participant Database

Client->AuthController: 1. POST /api/Auth/change-password (ChangePasswordDTO)
activate AuthController

AuthController->AuthController: 2. ValidateModel()
alt Validation Failed
    AuthController->Client: 3. Return 400 Bad Request
    deactivate AuthController
else Validation Success
    AuthController->AuthService: 4. Call ChangePassword(email, oldPassword, newPassword, cancellationToken)
    activate AuthService
    
    AuthService->AuthRepository: 5. GetUserByEmailAsync(email)
    activate AuthRepository
    AuthRepository->Database: 6. Query user by email
    activate Database
    Database-->AuthRepository: 7. Return user data or null
    deactivate Database
    AuthRepository-->AuthService: 8. Return user or null
    deactivate AuthRepository
    
    AuthService->AuthService: 9. ValidateOldPassword(user, oldPassword)
    alt User Not Found
        AuthService->AuthService: 10a. Throw InvalidOperationException("User not found")
        AuthService-->AuthController: 11a. Exception propagated
        AuthController->AuthController: 12a. HandleException(ex)
        AuthController->Client: 13a. Return 400 Bad Request
        deactivate AuthService
        deactivate AuthController
    else User Found
        alt Old Password Invalid
            AuthService->AuthService: 10b1. Verify old password hash
            AuthService->AuthService: 11b1. Throw ArgumentException("Invalid old password")
            AuthService-->AuthController: 12b1. Exception propagated
            AuthController->AuthController: 13b1. HandleException(ex)
            AuthController->Client: 14b1. Return 400 Bad Request
            deactivate AuthService
            deactivate AuthController
        else Old Password Valid
            AuthService->AuthService: 10b2. ValidateUserStatus(user)
            alt User Status Invalid (Deleted/Suspended/Inactive)
                AuthService->AuthService: 11b2a. Throw UnauthorizedAccessException
                AuthService-->AuthController: 12b2a. Exception propagated
                AuthController->AuthController: 13b2a. HandleException(ex)
                AuthController->Client: 14b2a. Return 401 Unauthorized
                deactivate AuthService
                deactivate AuthController
            else User Status Valid
                AuthService->AuthService: 11b2b. Hash new password
                AuthService->AuthService: 12b2b. Set user.PasswordHash = hashed new password
                AuthService->AuthRepository: 13b2b. UpdateUserAsync(user)
                activate AuthRepository
                AuthRepository->AuthRepository: 14b2b. Set UpdatedAt = DateTime.UtcNow
                AuthRepository->Database: 15b2b. UPDATE user (PasswordHash, UpdatedAt)
                activate Database
                Database-->AuthRepository: 16b2b. Return update result
                deactivate Database
                AuthRepository->Database: 17b2b. SaveChangesAsync()
                activate Database
                Database-->AuthRepository: 18b2b. Changes saved
                deactivate Database
                AuthRepository-->AuthService: 19b2b. Update completed
                deactivate AuthRepository
                AuthService-->AuthController: 20b2b. Task completed
                deactivate AuthService
                AuthController->Client: 21b2b. Return 200 OK ("Password changed successfully")
                deactivate AuthController
            end
        end
    end
end

note over Client,Database: User must provide correct old password\nto change to new password

