title Forgot Password Sequence Diagram

participant User
participant ForgotPasswordUI
participant AuthController
participant AuthService
participant AuthRepository
participant EmailSender
participant Database

User->ForgotPasswordUI: 1. Enter email and click "Gửi Email Đặt Lại Mật Khẩu"
ForgotPasswordUI->AuthController: 2. POST /api/Auth/forgot-password (SendEmailDTO)
activate AuthController

AuthController->AuthController: 3. ValidateModel()
alt Validation Failed
    AuthController->ForgotPasswordUI: 4.1 Return 400 Bad Request
    ForgotPasswordUI->User: 5.1 Show validation error
    deactivate AuthController
else Validation Success
    AuthController->AuthService: 4.2 Call SendForgotPasswordEmailAsync(email)
    activate AuthService
    
    AuthService->AuthRepository: 5.2 GetUserByEmailAsync(email)
    activate AuthRepository
    AuthRepository->Database: 6.2 Check if user exists
    Database-->AuthRepository: 7.2 Return user data or null
    AuthRepository-->AuthService: 8.2 Return user or null
    deactivate AuthRepository
    
    alt User Not Found
        AuthService-->AuthController: 9.2.1 Throw InvalidOperationException
        AuthController->ForgotPasswordUI: 10.2.1 Return 400 Bad Request
        ForgotPasswordUI->User: 11.2.1 Show error message
        deactivate AuthService
        deactivate AuthController
    else User Found
        AuthService->AuthService: 9.2.2 ValidateUserStatus(user)
        alt User Status Invalid
            AuthService-->AuthController: 10.2.2.1 Throw InvalidOperationException
            AuthController->ForgotPasswordUI: 11.2.2.1 Return 400 Bad Request
            ForgotPasswordUI->User: 12.2.2.1 Show error message
            deactivate AuthService
            deactivate AuthController
        else User Status Valid
            AuthService->AuthService: 10.2.2.2 GenerateNumericCode(8)
            AuthService->EmailSender: 11.2.2.2 SendForgotPasswordEmailAsync(email, fullName, code)
            activate EmailSender
            EmailSender->EmailSender: 12.2.2.2 Send email with reset code
            EmailSender-->AuthService: 13.2.2.2 Return email sent confirmation
            deactivate EmailSender
            
            AuthService->AuthRepository: 14.2.2.2 UpdateUserAsync(user with code and VerificationSentAt)
            activate AuthRepository
            AuthRepository->Database: 15.2.2.2 Update user verification token and sent time
            Database-->AuthRepository: 16.2.2.2 Return update result
            AuthRepository-->AuthService: 17.2.2.2 Return update confirmation
            deactivate AuthRepository
            
            AuthService-->AuthController: 18.2.2.2 Return success
            deactivate AuthService
            AuthController->ForgotPasswordUI: 19.2.2.2 Return 200 OK ("Forgot password email sent successfully")
            deactivate AuthController
            ForgotPasswordUI->User: 20.2.2.2 Show success message and redirect to reset password page
        end
    end
end

