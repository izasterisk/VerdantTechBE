title Create CO2 Footprint Sequence Diagram

participant Client
participant CO2Controller
participant CO2Service
participant MemoryCache
participant EnvironmentalDataRepository
participant FarmProfileRepository
participant SoilGridsApiClient
participant WeatherApiClient
participant Database

Client->CO2Controller: 1. POST /api/CO2/farm/{farmId} (CO2FootprintCreateDTO)
activate CO2Controller

CO2Controller->CO2Controller: 2. ValidateModel()
alt Validation Failed
    CO2Controller->Client: 3. Return 400 Bad Request
    deactivate CO2Controller
else Validation Success
    CO2Controller->CO2Service: 4. CreateCO2FootprintAsync(farmId, dto, ct)
    activate CO2Service
    
    alt Invalid Date Range (EndDate <= StartDate or > Today)
        CO2Service->CO2Service: 5a. Throw InvalidOperationException("Ngày không hợp lệ")
        CO2Service-->CO2Controller: 6a. Exception propagated
        CO2Controller->CO2Controller: 7a. HandleException(ex)
        CO2Controller->Client: 8a. Return 400 Bad Request
        deactivate CO2Service
        deactivate CO2Controller
    else Valid Date Range
        CO2Service->EnvironmentalDataRepository: 5b. GetEnvironmentDataByFarmIdAndDateRangeAsync(farmId, dates)
        activate EnvironmentalDataRepository
        EnvironmentalDataRepository->Database: 6b. Query existing data by farm and date range
        activate Database
        Database-->EnvironmentalDataRepository: 7b. Return exists status
        deactivate Database
        EnvironmentalDataRepository-->CO2Service: 8b. Return dataExists (bool)
        deactivate EnvironmentalDataRepository
        
        alt Data Already Exists
            CO2Service->CO2Service: 9b1. Throw InvalidOperationException("Dữ liệu đã tồn tại")
            CO2Service-->CO2Controller: 10b1. Exception propagated
            CO2Controller->CO2Controller: 11b1. HandleException(ex)
            CO2Controller->Client: 12b1. Return 400 Bad Request
            deactivate CO2Service
            deactivate CO2Controller
        else Data Not Exists
            CO2Service->FarmProfileRepository: 9b2. GetFarmWithAddressByFarmIdAsync(farmId, useNoTracking: true)
            activate FarmProfileRepository
            FarmProfileRepository->Database: 10b2. Query farm with address (Latitude, Longitude)
            activate Database
            Database-->FarmProfileRepository: 11b2. Return farm profile
            deactivate Database
            FarmProfileRepository-->CO2Service: 12b2. Return farmProfile
            deactivate FarmProfileRepository
            
            alt Farm Has No Coordinates
                CO2Service->CO2Service: 13b2a. Throw InvalidOperationException("Chưa có tọa độ")
                CO2Service-->CO2Controller: 14b2a. Exception propagated
                CO2Controller->CO2Controller: 15b2a. HandleException(ex)
                CO2Controller->Client: 16b2a. Return 400 Bad Request
                deactivate CO2Service
                deactivate CO2Controller
            else Farm Has Coordinates
                CO2Service->MemoryCache: 13b2b. Check soil cache by farmId
                activate MemoryCache
                MemoryCache-->CO2Service: 14b2b. Return cached soil data or null
                deactivate MemoryCache
                
                alt Soil Not in Cache
                    CO2Service->SoilGridsApiClient: 15b2b1. GetSoilDataAsync(lat, lon)
                    activate SoilGridsApiClient
                    SoilGridsApiClient-->CO2Service: 16b2b1. Return SoilDataResult
                    deactivate SoilGridsApiClient
                end
                
                CO2Service->MemoryCache: 15b2b2. Check weather cache by farmId and date range
                activate MemoryCache
                MemoryCache-->CO2Service: 16b2b2. Return cached weather data or null
                deactivate MemoryCache
                
                alt Weather Not in Cache or Outside Date Range
                    CO2Service->WeatherApiClient: 17b2b2a. GetHistoricalWeatherDataAsync(lat, lon, dates)
                    activate WeatherApiClient
                    WeatherApiClient-->CO2Service: 18b2b2a. Return WeatherDataResult
                    deactivate WeatherApiClient
                end
                
                CO2Service->CO2Service: 17b2b3. Calculate weighted averages for soil (sand, silt, clay, pH)
                CO2Service->CO2Service: 18b2b3. Calculate weather averages (precipitation, evapotranspiration)
                CO2Service->CO2Service: 19b2b3. Map DTO to EnvironmentalDatum entity
                CO2Service->CO2Service: 20b2b3. Map DTO to EnergyUsage entity
                CO2Service->CO2Service: 21b2b3. Map DTO to Fertilizer entity
                CO2Service->CO2Service: 22b2b3. ComputeCo2Footprint(soil, weather, energy, fertilizer)
                CO2Service->CO2Service: 23b2b3. Set environmentalData.Co2Footprint
                
                CO2Service->EnvironmentalDataRepository: 24b2b3. CreateEnvironmentalDataWithTransactionAsync(env, fertilizer, energy)
                activate EnvironmentalDataRepository
                EnvironmentalDataRepository->Database: 25b2b3. Begin Transaction
                activate Database
                EnvironmentalDataRepository->Database: 26b2b3. INSERT environmental_data
                Database-->EnvironmentalDataRepository: 27b2b3. Environmental data created
                EnvironmentalDataRepository->Database: 28b2b3. INSERT energy_usage
                Database-->EnvironmentalDataRepository: 29b2b3. Energy usage created
                EnvironmentalDataRepository->Database: 30b2b3. INSERT fertilizer
                Database-->EnvironmentalDataRepository: 31b2b3. Fertilizer created
                EnvironmentalDataRepository->Database: 32b2b3. Commit Transaction
                Database-->EnvironmentalDataRepository: 33b2b3. Transaction committed
                deactivate Database
                EnvironmentalDataRepository-->CO2Service: 34b2b3. Return created EnvironmentalDatum
                deactivate EnvironmentalDataRepository
                
                CO2Service->CO2Service: 35b2b3. Map to CO2FootprintResponseDTO
                CO2Service-->CO2Controller: 36b2b3. Return CO2FootprintResponseDTO
                deactivate CO2Service
                CO2Controller->Client: 37b2b3. Return 201 Created (CO2FootprintResponseDTO)
                deactivate CO2Controller
            end
        end
    end
end

note over Client,Database: Fetches soil & weather from external APIs (with cache)\nCalculates CO2 footprint using complex formula\nTransaction: environmental_data + energy_usage + fertilizer
