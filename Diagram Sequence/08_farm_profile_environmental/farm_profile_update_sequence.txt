title Update Farm Profile Sequence Diagram

participant Client
participant FarmProfileController
participant FarmProfileService
participant FarmProfileRepository
participant AddressRepository
participant Database

Client->FarmProfileController: 1. PATCH /api/FarmProfile/{id} (FarmProfileUpdateDTO)
activate FarmProfileController

note over FarmProfileController: Requires Authorization

FarmProfileController->FarmProfileController: 2. ValidateModel()
alt Validation Failed
    FarmProfileController->Client: 3a. Return 400 Bad Request
    deactivate FarmProfileController
else Validation Success
    FarmProfileController->FarmProfileService: 3b. UpdateFarmProfileAsync(id, dto, cancellationToken)
    activate FarmProfileService
    
    FarmProfileService->FarmProfileService: 4b. Validate dto not null
    alt DTO is null
        FarmProfileService->FarmProfileService: 5b1. Throw ArgumentNullException
        FarmProfileService-->FarmProfileController: 6b1. Exception propagated
        FarmProfileController->FarmProfileController: 7b1. HandleException(ex)
        FarmProfileController->Client: 8b1. Return 400 Bad Request
        deactivate FarmProfileService
        deactivate FarmProfileController
    else DTO is valid
        FarmProfileService->FarmProfileRepository: 5b2. GetFarmProfileByFarmIdAsync(id, cancellationToken)
        activate FarmProfileRepository
        FarmProfileRepository->Database: 6b2. Query FarmProfile by ID where Status = Active
        activate Database
        Database-->FarmProfileRepository: 7b2. Return farm profile or null
        deactivate Database
        FarmProfileRepository-->FarmProfileService: 8b2. Return farm profile or null
        deactivate FarmProfileRepository
        
        alt Farm Profile Not Found
            FarmProfileService->FarmProfileService: 9b2a. Throw KeyNotFoundException
            FarmProfileService-->FarmProfileController: 10b2a. Exception propagated
            FarmProfileController->FarmProfileController: 11b2a. HandleException(ex)
            FarmProfileController->Client: 12b2a. Return 404 Not Found
            deactivate FarmProfileService
            deactivate FarmProfileController
        else Farm Profile Found
            FarmProfileService->AddressRepository: 9b2b. GetAddressByIdAsync(farmProfile.AddressId, cancellationToken)
            activate AddressRepository
            AddressRepository->Database: 10b2b. Query Address by ID
            activate Database
            Database-->AddressRepository: 11b2b. Return address or null
            deactivate Database
            AddressRepository-->FarmProfileService: 12b2b. Return address or null
            deactivate AddressRepository
            
            alt Address Not Found
                FarmProfileService->FarmProfileService: 13b2b1. Throw KeyNotFoundException("Không tìm thấy địa chỉ")
                FarmProfileService-->FarmProfileController: 14b2b1. Exception propagated
                FarmProfileController->FarmProfileController: 15b2b1. HandleException(ex)
                FarmProfileController->Client: 16b2b1. Return 404 Not Found
                deactivate FarmProfileService
                deactivate FarmProfileController
            else Address Found
                FarmProfileService->FarmProfileService: 13b2b2. ValidateAddressFields(province, district, commune codes)
                alt Address Validation Failed
                    FarmProfileService->FarmProfileService: 14b2b2a. Throw ArgumentException
                    FarmProfileService-->FarmProfileController: 15b2b2a. Exception propagated
                    FarmProfileController->FarmProfileController: 16b2b2a. HandleException(ex)
                    FarmProfileController->Client: 17b2b2a. Return 400 Bad Request
                    deactivate FarmProfileService
                    deactivate FarmProfileController
                else Address Validation Success
                    FarmProfileService->FarmProfileService: 14b2b2b. Map FarmProfileUpdateDTO to farmProfile entity
                    FarmProfileService->FarmProfileService: 15b2b2b. Map FarmProfileUpdateDTO to address entity
                    
                    FarmProfileService->FarmProfileRepository: 16b2b2b. UpdateFarmProfileWithTransactionAsync(farmProfile, address, cancellationToken)
                    activate FarmProfileRepository
                    FarmProfileRepository->Database: 17b2b2b. Begin Transaction
                    activate Database
                    Database-->FarmProfileRepository: 18b2b2b. Transaction started
                    deactivate Database
                    
                    FarmProfileRepository->FarmProfileRepository: 19b2b2b. Set address.UpdatedAt = DateTime.UtcNow
                    FarmProfileRepository->AddressRepository: 20b2b2b. UpdateAddressAsync(address, cancellationToken)
                    activate AddressRepository
                    AddressRepository->AddressRepository: 21b2b2b. Set address.UpdatedAt = DateTime.UtcNow
                    AddressRepository->Database: 22b2b2b. UPDATE Address
                    activate Database
                    Database-->AddressRepository: 23b2b2b. Update completed
                    deactivate Database
                    AddressRepository->Database: 24b2b2b. SaveChangesAsync()
                    activate Database
                    Database-->AddressRepository: 25b2b2b. Changes saved
                    deactivate Database
                    AddressRepository-->FarmProfileRepository: 26b2b2b. Return updated address
                    deactivate AddressRepository
                    
                    FarmProfileRepository->FarmProfileRepository: 27b2b2b. Set farmProfile.UpdatedAt = DateTime.UtcNow
                    FarmProfileRepository->Database: 28b2b2b. UPDATE FarmProfile
                    activate Database
                    Database-->FarmProfileRepository: 29b2b2b. Update completed
                    deactivate Database
                    FarmProfileRepository->Database: 30b2b2b. SaveChangesAsync()
                    activate Database
                    Database-->FarmProfileRepository: 31b2b2b. Changes saved
                    deactivate Database
                    
                    FarmProfileRepository->Database: 32b2b2b. Commit Transaction
                    activate Database
                    Database-->FarmProfileRepository: 33b2b2b. Transaction committed
                    deactivate Database
                    
                    FarmProfileRepository->Database: 34b2b2b. Query FarmProfile by ID with User, Address, Crops
                    activate Database
                    Database-->FarmProfileRepository: 35b2b2b. Return farm profile with relations
                    deactivate Database
                    
                    FarmProfileRepository-->FarmProfileService: 36b2b2b. Return updated farm profile with relations
                    deactivate FarmProfileRepository
                    
                    FarmProfileService->FarmProfileService: 37b2b2b. Map FarmProfile to FarmProfileResponseDTO
                    FarmProfileService->FarmProfileService: 38b2b2b. Map User to UserResponseDTO and set response.User
                    alt updatedFarmProfile.Address != null
                        FarmProfileService->FarmProfileService: 39b2b2b. Map Address to AddressResponseDTO and set response.Address
                    end
                    FarmProfileService-->FarmProfileController: 40b2b2b. Return FarmProfileResponseDTO
                    deactivate FarmProfileService
                    FarmProfileController->Client: 41b2b2b. Return 200 OK (FarmProfileResponseDTO)
                    deactivate FarmProfileController
                end
            end
        end
    end
end

note over Client,Database: Updates address first, then farm profile in transaction.\nReloads with relations after commit.
