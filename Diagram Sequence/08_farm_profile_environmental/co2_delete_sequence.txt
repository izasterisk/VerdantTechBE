title Delete Environmental Data Sequence Diagram

participant Client
participant CO2Controller
participant CO2Service
participant EnvironmentalDataRepository
participant FertilizerRepository
participant EnergyUsageRepository
participant Database

Client->CO2Controller: 1. DELETE /api/CO2/{id}
activate CO2Controller

note over CO2Controller: Requires Authorization

CO2Controller->CO2Service: 2. DeleteEnvironmentalDataByIdAsync(id, cancellationToken)
activate CO2Service

CO2Service->EnvironmentalDataRepository: 3. DeleteEnvironmentalDataByIdWithTransactionAsync(id, cancellationToken)
activate EnvironmentalDataRepository

EnvironmentalDataRepository->Database: 4. Begin Transaction
activate Database
Database-->EnvironmentalDataRepository: 5. Transaction started
deactivate Database

EnvironmentalDataRepository->EnvironmentalDataRepository: 6. Call GetEnvironmentDataById(id, cancellationToken)
EnvironmentalDataRepository->Database: 7. Query EnvironmentalDatum by ID with Fertilizer and EnergyUsage
activate Database
Database-->EnvironmentalDataRepository: 8. Return EnvironmentalDatum or null
deactivate Database

alt Data Not Found
    EnvironmentalDataRepository-->CO2Service: 9a. Return false
    deactivate EnvironmentalDataRepository
    CO2Service->CO2Service: 10a. Set result message = "Xóa thất bại."
    CO2Service-->CO2Controller: 11a. Return "Xóa thất bại."
    deactivate CO2Service
    CO2Controller->Client: 12a. Return 200 OK ("Xóa thất bại.")
    deactivate CO2Controller
else Data Found
    alt Has Fertilizer
        EnvironmentalDataRepository->FertilizerRepository: 9b1. DeleteFertilizerAsync(fertilizer, cancellationToken)
        activate FertilizerRepository
        FertilizerRepository->Database: 10b1. DELETE Fertilizer
        activate Database
        Database-->FertilizerRepository: 11b1. Delete completed
        deactivate Database
        FertilizerRepository->Database: 12b1. SaveChangesAsync()
        activate Database
        Database-->FertilizerRepository: 13b1. Changes saved
        deactivate Database
        FertilizerRepository-->EnvironmentalDataRepository: 14b1. Fertilizer deleted
        deactivate FertilizerRepository
    end
    
    alt Has EnergyUsage
        EnvironmentalDataRepository->EnergyUsageRepository: 15b2. DeleteEnergyUsageAsync(energyUsage, cancellationToken)
        activate EnergyUsageRepository
        EnergyUsageRepository->Database: 16b2. DELETE EnergyUsage
        activate Database
        Database-->EnergyUsageRepository: 17b2. Delete completed
        deactivate Database
        EnergyUsageRepository->Database: 18b2. SaveChangesAsync()
        activate Database
        Database-->EnergyUsageRepository: 19b2. Changes saved
        deactivate Database
        EnergyUsageRepository-->EnvironmentalDataRepository: 20b2. EnergyUsage deleted
        deactivate EnergyUsageRepository
    end
    
    EnvironmentalDataRepository->Database: 21b. DELETE EnvironmentalDatum
    activate Database
    Database-->EnvironmentalDataRepository: 22b. Delete completed
    deactivate Database
    
    EnvironmentalDataRepository->Database: 23b. SaveChangesAsync()
    activate Database
    Database-->EnvironmentalDataRepository: 24b. Changes saved
    deactivate Database
    
    EnvironmentalDataRepository->Database: 25b. Commit Transaction
    activate Database
    Database-->EnvironmentalDataRepository: 26b. Transaction committed
    deactivate Database
    
    EnvironmentalDataRepository-->CO2Service: 27b. Return true
    deactivate EnvironmentalDataRepository
    CO2Service->CO2Service: 28b. Set result message = "Xóa thành công."
    CO2Service-->CO2Controller: 29b. Return "Xóa thành công."
    deactivate CO2Service
    CO2Controller->Client: 30b. Return 200 OK ("Xóa thành công.")
    deactivate CO2Controller
end

note over Client,Database: This is a HARD DELETE with transaction.\nDeletes related Fertilizer and EnergyUsage first.
