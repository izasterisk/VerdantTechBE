title Get Hourly Weather Sequence Diagram

participant Client
participant WeatherController
participant WeatherService
participant MemoryCache
participant FarmProfileRepository
participant WeatherApiClient
participant Database

Client->WeatherController: 1. GET /api/Weather/hourly/{farmId}
activate WeatherController

WeatherController->WeatherService: 2. GetHourlyWeatherDetailsByFarmIdAsync(farmId, ct)
activate WeatherService

WeatherService->MemoryCache: 3. Check cache (key: "weather:hourly:{farmId}")
activate MemoryCache
MemoryCache-->WeatherService: 4. Return cached data or null
deactivate MemoryCache

alt Weather in Cache
    WeatherService-->WeatherController: 5a. Return cached HourlyWeatherResponseDto
    deactivate WeatherService
    WeatherController->Client: 6a. Return 200 OK (HourlyWeatherResponseDto)
    deactivate WeatherController
else Cache Miss
    WeatherService->FarmProfileRepository: 5b. GetFarmWithAddressByFarmIdAsync(farmId, useNoTracking: true)
    activate FarmProfileRepository
    FarmProfileRepository->Database: 6b. Query farm with address (Latitude, Longitude)
    activate Database
    Database-->FarmProfileRepository: 7b. Return farm profile
    deactivate Database
    FarmProfileRepository-->WeatherService: 8b. Return farmProfile
    deactivate FarmProfileRepository
    
    alt Farm Has No Coordinates
        WeatherService->WeatherService: 9b1. Throw InvalidOperationException("Chưa có địa chỉ")
        WeatherService-->WeatherController: 10b1. Exception propagated
        WeatherController->WeatherController: 11b1. HandleException(ex)
        WeatherController->Client: 12b1. Return 400 Bad Request
        deactivate WeatherService
        deactivate WeatherController
    else Farm Has Coordinates
        WeatherService->WeatherApiClient: 9b2. GetHourlyWeatherAsync(lat, lon)
        activate WeatherApiClient
        alt External API Timeout
            WeatherApiClient->WeatherApiClient: 10b2a. Throw TimeoutException
            WeatherApiClient-->WeatherService: 11b2a. TimeoutException
            deactivate WeatherApiClient
            WeatherService-->WeatherController: 12b2a. TimeoutException propagated
            WeatherController->WeatherController: 13b2a. HandleException(ex)
            WeatherController->Client: 14b2a. Return 408/499
            deactivate WeatherService
            deactivate WeatherController
        else External API Error
            WeatherApiClient->WeatherApiClient: 10b2b. Throw Exception
            WeatherApiClient-->WeatherService: 11b2b. Exception caught
            deactivate WeatherApiClient
            WeatherService->WeatherService: 12b2b. Throw InvalidOperationException("Server thời tiết quá tải")
            WeatherService-->WeatherController: 13b2b. Exception propagated
            WeatherController->WeatherController: 14b2b. HandleException(ex)
            WeatherController->Client: 15b2b. Return 400 Bad Request
            deactivate WeatherService
            deactivate WeatherController
        else External API Success
            WeatherApiClient-->WeatherService: 10b2c. Return HourlyWeatherResponseDto
            deactivate WeatherApiClient
            WeatherService-->WeatherController: 11b2c. Return HourlyWeatherResponseDto
            deactivate WeatherService
            WeatherController->Client: 12b2c. Return 200 OK (HourlyWeatherResponseDto)
            deactivate WeatherController
        end
    end
end

note over Client,Database: Checks cache first (key: "weather:hourly:{farmId}")\nFalls back to external Weather API if cache miss\nHandles TimeoutException and generic API errors

